<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    
    :root {
      --verde-farmacia: #05642d;
      --fondo-oscuro: #1a1a1a;
      --texto-blanco: #ffffff;
      --azul-ventas: #1e88e5;
      --rojo-eliminar: #dc3545;
    }
    
    body {
      background-color: #000;
      color: var(--texto-blanco);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .container-mobile {
      max-width: 100%;
      padding: 15px;
    }

    .btn-submit {
      background-color: #05642d;
      color: #fff;
      padding: 10px 30px;
      border: none;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background-color: #cccccc;
      color: #000000;
      transform: translateY(-2px);
    }
    
    .logo-container {
      text-align: center;
      margin: 15px 0 25px;
    }
    
    .card-ventas {
      background-color: var(--fondo-oscuro);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .title-ventas {
      text-align: center;
      margin-bottom: 20px;
      color: var(--texto-blanco);
      font-size: 1.5rem;
    }
    
    .search-box {
      margin-bottom: 15px;
    }
    
    .search-input {
      width: 100%;
      padding: 10px 15px;
      background-color: #2a2a2a;
      border: 1px solid var(--verde-farmacia);
      border-radius: 5px;
      color: var(--texto-blanco);
    }
    
    .table-ventas {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .table-ventas th {
      background-color: var(--azul-ventas);
      color: white;
      padding: 12px 8px;
      text-align: left;
    }
    
    .table-ventas td {
      padding: 10px 8px;
      border-bottom: 1px solid #333;
    }
    
    .table-ventas tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    
    .table-ventas tr:hover {
      background-color: #333;
    }
    
    .btn-volver {
      display: block;
      width: 100%;
      background-color: #333;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      text-decoration: none;
    }
    
    .btn-volver:hover {
      background-color: #444;
      color: white;
    }
    
    /* Scroll horizontal para móviles */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Estilos para las tarjetas de resumen */
    .summary-cards {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-card {
      background-color: var(--fondo-oscuro);
      border-radius: 10px;
      padding: 15px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
    }

    .summary-icon {
      font-size: 2rem;
      margin-right: 15px;
      color: var(--azul-ventas);
    }

    .summary-content {
      flex: 1;
    }

    .summary-title {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 5px;
    }

    .summary-value {
      font-size: 1.3rem;
      font-weight: bold;
    }
    
    .summary-subvalue {
      font-size: 0.9rem;
      color: #aaa;
    }

    /* Filtros rápidos */
    .filtros-rapidos {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .filtros-fechas {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filtros-rapidos-fechas {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-filtro {
      background-color: #333;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-filtro:hover {
      background-color: #444;
    }

    .btn-filtro.active {
      background-color: var(--azul-ventas);
      font-weight: bold;
    }
    
    .rango-fechas {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .fecha-input {
      background-color: #2a2a2a;
      border: 1px solid var(--verde-farmacia);
      border-radius: 5px;
      color: var(--texto-blanco);
      padding: 5px 10px;
    }
    
    .fecha-label {
      font-size: 0.9rem;
      color: #aaa;
    }

    /* Botón eliminar */
    .btn-eliminar {
      background-color: var(--rojo-eliminar);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-eliminar:hover {
      background-color: #c82333;
    }

    /* Modal para detalles de venta */
    .modal-venta {
      color: var(--texto-blanco);
    }

    .modal-content {
      background-color: var(--fondo-oscuro);
    }

    .modal-header {
      border-bottom: 1px solid #333;
    }

    .modal-footer {
      border-top: 1px solid #333;
    }

    /* CSS adicional para la animación del spinner */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Pestañas para cambiar vista */
    .nav-tabs {
      border-bottom: 1px solid #444;
      margin-bottom: 20px;
    }

    .nav-tabs .nav-link {
      color: #aaa;
      border: none;
      border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link.active {
      color: var(--azul-ventas);
      background-color: transparent;
      border-bottom: 3px solid var(--azul-ventas);
    }

    .nav-tabs .nav-link:hover {
      color: white;
      border-color: #eee;
    }

    /* Tarjetas de productos - ESTILOS MODIFICADOS */
    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .producto-card {
      background-color: #2a2a2a;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
    }
    
    .producto-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .producto-nombre {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0 0 15px 0;
      text-align: center;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }
    
    .producto-tabla {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    
    .producto-tabla th {
      text-align: left;
      padding: 8px;
      background-color: #333;
    }
    
    .producto-tabla td {
      padding: 8px;
      border-bottom: 1px solid #444;
    }
    
    .producto-tabla tr:last-child td {
      border-bottom: none;
    }
    
    .producto-total {
      text-align: center;
      padding-top: 10px;
      border-top: 1px solid #444;
    }
    
    .total-label {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 5px;
    }
    
    .total-value {
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .moneda-usd {
      color: #17a2b8; /* Azul claro para dólares */
    }
    
    .moneda-bs {
      color: #28a745; /* Verde para bolívares */
    }
    
    /* Ajustes para pantallas pequeñas */
    @media (max-width: 768px) {
      .productos-grid {
        grid-template-columns: 1fr;
      }
      
      .filtros-fechas {
        flex-direction: column;
      }
      
      .filtros-rapidos-fechas {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .rango-fechas {
        flex-direction: column;
        align-items: stretch;
      }
      
      .rango-fechas-horizontal {
        display: none;
      }
      
      .rango-fechas-vertical {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .producto-details {
        grid-template-columns: 1fr;
      }
      
      .table-ventas th, 
      .table-ventas td {
        padding: 8px 5px;
        font-size: 0.9rem;
      }
      
      .table-ventas th {
        font-size: 0.95rem;
      }
      
      .summary-card {
        min-width: 100%;
      }
    }
    
    /* Para pantallas más grandes */
    @media (min-width: 769px) {
      .rango-fechas-vertical {
        display: none;
      }
      
      .rango-fechas-horizontal {
        display: flex;
        align-items: center;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container-mobile">
    <div class="row">
      <div class="col-12 text-center logo-container">
        <img alt="Logo" src="logo.png" class="img-fluid" height="150px" width="350px">
      </div>
    </div>
    
    <div class="card-ventas">
      <h2 class="title-ventas">REPORTE DE VENTAS</h2>
      
      <!-- Pestañas para cambiar vista -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab" aria-controls="productos" aria-selected="true">Ventas por Producto</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="detalles-tab" data-bs-toggle="tab" data-bs-target="#detalles" type="button" role="tab" aria-controls="detalles" aria-selected="false">Detalles de Ventas</button>
        </li>
      </ul>
      
      <div class="tab-content" id="myTabContent">
        <!-- Vista de productos -->
        <div class="tab-pane fade show active" id="productos" role="tabpanel" aria-labelledby="productos-tab">
          <!-- Tarjetas de resumen -->
          <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Total Ventas</div>
                <div class="summary-value" id="totalVentas">0</div>
              </div>
            </div>
            
            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Monto Total</div>
                <div class="summary-value moneda-usd" id="montoTotalUSD">$ 0.00</div>
                <div class="summary-subvalue moneda-bs" id="montoTotalBS">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-store"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Punto de Venta</div>
                <div class="summary-value moneda-bs" id="ventasPunto">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-money-bill"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Efectivo</div>
                <div class="summary-value moneda-bs" id="ventasEfectivo">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-mobile-alt"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Pago Móvil</div>
                <div class="summary-value moneda-bs" id="ventasMovil">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Dólares</div>
                <div class="summary-value moneda-usd" id="ventasDolares">$ 0.00</div>
              </div>
            </div>
          </div>

          <!-- Filtros de fechas -->
          <div class="filtros-fechas" id="filtrosFechas" style="display: none;">
            <div class="filtros-rapidos-fechas">
              <button class="btn-filtro active" data-fecha-filtro="all">Todas las fechas</button>
              <button class="btn-filtro" data-fecha-filtro="mes">Este mes</button>
            </div>
            
            <div class="rango-fechas">
              <!-- Versión horizontal para escritorio -->
              <div class="rango-fechas-horizontal">
                <span class="fecha-label">Rango personalizado:</span>
                <input type="date" class="fecha-input" id="fechaInicio">
                <span class="fecha-label">a</span>
                <input type="date" class="fecha-input" id="fechaFin">
                <button class="btn-filtro" id="aplicarRango">Aplicar</button>
              </div>
              
              <!-- Versión vertical para móviles -->
              <div class="rango-fechas-vertical">
                <span class="fecha-label">Rango personalizado:</span>
                <input type="date" class="fecha-input mb-2" id="fechaInicioMobile" placeholder="Fecha inicio">
                <span class="fecha-label">a</span>
                <input type="date" class="fecha-input mb-2" id="fechaFinMobile" placeholder="Fecha fin">
                <button class="btn-filtro" id="aplicarRangoMobile">Aplicar</button>
              </div>
            </div>
          </div>

          <!-- Filtros rápidos -->
          <div class="filtros-rapidos" id="filtrosRapidos" style="display: none;">
            <button class="btn-filtro active" data-filter="all">Todas</button>
            <button class="btn-filtro" data-filter="Punto de venta">Punto de Venta</button>
            <button class="btn-filtro" data-filter="Efectivo">Efectivo</button>
            <button class="btn-filtro" data-filter="Pago móvil">Pago Móvil</button>
            <button class="btn-filtro" data-filter="Dólares">Dólares</button>
          </div>
          
          <div class="search-box">
            <input type="text" class="search-input" placeholder="Buscar por producto o marca..." id="buscadorVentas">
          </div>
          
          <!-- Loading indicator -->
          <div id="loadingIndicator" class="text-center" style="padding: 20px;">
            <svg style="animation: spin 1s linear infinite; display: inline-block; width: 24px; height: 24px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Cargando ventas...</p>
          </div>
          
          <!-- Grid de productos -->
          <div class="productos-grid" id="productosGrid" style="display: none;">
            <!-- Las tarjetas de productos se cargarán aquí dinámicamente -->
          </div>
        </div>
        
        <!-- Vista de detalles de ventas -->
        <div class="tab-pane fade" id="detalles" role="tabpanel" aria-labelledby="detalles-tab">
          <div class="table-responsive" id="tableContainer" style="display: none;">
            <table class="table-ventas">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Producto</th>
                  <th>Marca</th>
                  <th>Tipo Pago</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tablaVentas">
                <!-- Los datos se cargarán aquí dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay ventas -->
      <div id="emptyMessage" class="text-center" style="display: none; padding: 40px;">
        <p>No hay ventas registradas.</p>
      </div>
      
      <!-- Mensaje de error -->
      <div id="errorMessage" class="text-center" style="display: none; padding: 40px; color: #ff6b6b;">
        <p>Error al cargar ventas. Por favor, recarga la página.</p>
      </div>
      <br>
      <div class="text-center">
         <a class="btn btn-submit btn-lg" href="../inventario/index.html">Volver al Menú</a>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar eliminación -->
  <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content modal-venta">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmarEliminarModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta venta? Esta acción no se puede deshacer.</p>
          <p><strong>Nota:</strong> Se eliminarán todos los detalles asociados a esta venta.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Incluir Supabase SDK y Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
   // Configuración de Supabase
    const SUPABASE_URL = 'https://rirfvhvlmytnpqkcpxbx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcmZ2aHZsbXl0bnBxa2NweGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODE2NDUsImV4cCI6MjA3MjA1NzY0NX0.5JLGuOIWNvKIESJG26JLOgRVCu0jVoH0ELZjQ63gV48';
     
    // Inicializar Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variable global para almacenar datos
    let ventasCompletas = [];
    let detallesVentas = [];
    let pagosVentas = [];
    let productosMap = {};
    let filtroActual = 'all';
    let filtroFechaTipo = 'all'; // all, hoy, semana, mes, rango
    let fechaInicioRango = null;
    let fechaFinRango = null;
    let ventaAEliminar = null;

    // Función para formatear fecha (solo fecha, sin hora) - CORREGIDA
    function formatearFecha(fechaStr) {
      // Ajustar por zona horaria: añadir el offset para evitar el problema de un día menos
      const fecha = new Date(fechaStr);
      fecha.setMinutes(fecha.getMinutes() + fecha.getTimezoneOffset());
      
      const dia = fecha.getDate().toString().padStart(2, '0');
      const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
      const año = fecha.getFullYear();
      return `${dia}/${mes}/${año}`;
    }

    // Función para obtener el inicio del día
    function inicioDelDia(fecha = new Date()) {
      const inicio = new Date(fecha);
      inicio.setHours(0, 0, 0, 0);
      return inicio;
    }

    // Función para obtener el fin del día
    function finDelDia(fecha = new Date()) {
      const fin = new Date(fecha);
      fin.setHours(23, 59, 59, 999);
      return fin;
    }

    // Función para obtener el inicio de la semana (lunes)
    function inicioDeSemana() {
      const hoy = new Date();
      const dia = hoy.getDay();
      const diff = hoy.getDate() - dia + (dia === 0 ? -6 : 1); // Ajuste para que la semana empiece en lunes
      return inicioDelDia(new Date(hoy.setDate(diff)));
    }

    // Función para obtener el fin de la semana (domingo)
    function finDeSemana() {
      const inicio = inicioDeSemana();
      const fin = new Date(inicio);
      fin.setDate(inicio.getDate() + 6);
      return finDelDia(fin);
    }

    // Función para obtener el inicio del mes
    function inicioDeMes() {
      const hoy = new Date();
      return inicioDelDia(new Date(hoy.getFullYear(), hoy.getMonth(), 1));
    }

    // Función para obtener el fin del mes
    function finDeMes() {
      const hoy = new Date();
      return finDelDia(new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0));
    }

    // Función para cargar datos desde Supabase
    async function cargarDatos() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const tableContainer = document.getElementById('tableContainer');
      const productosGrid = document.getElementById('productosGrid');
      const emptyMessage = document.getElementById('emptyMessage');
      const errorMessage = document.getElementById('errorMessage');
      const summaryCards = document.getElementById('summaryCards');
      const filtrosRapidos = document.getElementById('filtrosRapidos');
      const filtrosFechas = document.getElementById('filtrosFechas');
      
      try {
        // Mostrar loading
        loadingIndicator.style.display = 'block';
        tableContainer.style.display = 'none';
        productosGrid.style.display = 'none';
        emptyMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        summaryCards.style.display = 'none';
        filtrosRapidos.style.display = 'none';
        filtrosFechas.style.display = 'none';

        // Obtener datos en paralelo
        const [productosResponse, ventasResponse, detallesResponse, pagosResponse] = await Promise.all([
          supabaseClient.from('productos').select('id, nombre, marca, cantidad_por_empaque, precio_venta_1_usd'),
          supabaseClient.from('ventas').select('*').order('fecha', { ascending: false }),
          supabaseClient.from('detalles_venta').select('*'),
          supabaseClient.from('pagos_venta').select('*')
        ]);

        if (productosResponse.error) throw productosResponse.error;
        if (ventasResponse.error) throw ventasResponse.error;
        if (detallesResponse.error) throw detallesResponse.error;
        if (pagosResponse.error) throw pagosResponse.error;

        // Crear mapa de productos para búsqueda rápida
        productosMap = {};
        productosResponse.data.forEach(producto => {
          productosMap[producto.id] = {
            nombre: producto.nombre,
            marca: producto.marca || 'Sin marca',
            cantidad_por_empaque: producto.cantidad_por_empaque || 1,
            precio_usd: producto.precio_venta_1_usd || 0
          };
        });

        // Procesar ventas y detalles
        ventasCompletas = ventasResponse.data || [];
        detallesVentas = detallesResponse.data || [];
        pagosVentas = pagosResponse.data || [];

        // Ordenar ventas por fecha (más reciente primero)
        ventasCompletas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        // Calcular estadísticas
        let totalVentas = 0;
        let montoTotalUsd = 0;
        let montoTotalBs = 0;
        let ventasPuntoBs = 0;
        let ventasEfectivoBs = 0;
        let ventasMovilBs = 0;
        let ventasDolaresUsd = 0;

        // Calcular montos totales desde la tabla ventas
        ventasCompletas.forEach(venta => {
          montoTotalUsd += venta.total_usd || 0;
          montoTotalBs += venta.total || 0;
        });

        // Contar ventas únicas (una venta puede tener múltiples productos)
        const ventasUnicas = new Set(detallesVentas.map(d => d.venta_id));
        totalVentas = ventasUnicas.size;

        // Calcular montos por tipo de pago desde la tabla pagos_venta
        pagosVentas.forEach(pago => {
          switch(pago.metodo) {
            case 'Punto de venta':
              ventasPuntoBs += pago.monto_bs || 0;
              break;
            case 'Efectivo':
              ventasEfectivoBs += pago.monto_bs || 0;
              break;
            case 'Pago móvil':
              ventasMovilBs += pago.monto_bs || 0;
              break;
            case 'Dólares':
              ventasDolaresUsd += pago.monto_usd || 0;
              break;
          }
        });

        // Actualizar tarjetas de resumen
        document.getElementById('totalVentas').textContent = totalVentas;
        document.getElementById('montoTotalUSD').textContent = `$ ${montoTotalUsd.toFixed(2)}`;
        document.getElementById('montoTotalBS').textContent = `Bs ${montoTotalBs.toFixed(2)}`;
        document.getElementById('ventasPunto').textContent = `Bs ${ventasPuntoBs.toFixed(2)}`;
        document.getElementById('ventasEfectivo').textContent = `Bs ${ventasEfectivoBs.toFixed(2)}`;
        document.getElementById('ventasMovil').textContent = `Bs ${ventasMovilBs.toFixed(2)}`;
        document.getElementById('ventasDolares').textContent = `$ ${ventasDolaresUsd.toFixed(2)}`;

        summaryCards.style.display = 'flex';
        filtrosRapidos.style.display = 'flex';
        filtrosFechas.style.display = 'flex';

        // Ocultar loading
        loadingIndicator.style.display = 'none';

        if (detallesVentas.length > 0) {
          // Mostrar productos agrupados
          mostrarProductosAgrupados();
          productosGrid.style.display = 'grid';
          
          // Mostrar tabla de detalles
          mostrarDetallesVentas();
          tableContainer.style.display = 'block';
        } else {
          // Mostrar mensaje de no hay ventas
          emptyMessage.style.display = 'block';
        }

      } catch (error) {
        console.error('Error al cargar datos:', error);
        
        // Ocultar loading y mostrar error
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'block';
      }
    }

    // Función para agrupar y mostrar productos - MODIFICADA
    function mostrarProductosAgrupados() {
      const productosGrid = document.getElementById('productosGrid');
      productosGrid.innerHTML = '';
      
      // Crear array de detalles con información de venta asociada
      const detallesConVenta = detallesVentas.map(detalle => {
        const venta = ventasCompletas.find(v => v.id === detalle.venta_id);
        return {
          ...detalle,
          venta: venta
        };
      });

      // Filtrar según los filtros seleccionados
      let detallesFiltrados = aplicarFiltros(detallesConVenta);
      
      // Agrupar por producto
      const productosAgrupados = {};
      
      detallesFiltrados.forEach(item => {
        if (!productosAgrupados[item.producto_id]) {
          productosAgrupados[item.producto_id] = {
            nombre: productosMap[item.producto_id]?.nombre,
            marca: productosMap[item.producto_id]?.marca || 'Sin marca',
            id: item.producto_id,
            cantidad: 0,
            subtotal_bs: 0,
            subtotal_usd: 0
          };
        }
        
        productosAgrupados[item.producto_id].cantidad += item.cantidad;
        
        // Obtener información del producto
        const productoInfo = productosMap[item.producto_id];
        const cantidadPorEmpaque = productoInfo?.cantidad_por_empaque || 1;
        const precioUsd = productoInfo?.precio_usd || 0;
        
        // Calcular precio unitario CORREGIDO: dividir precio_usd por cantidad_por_empaque
        const precioUnitarioUsd = precioUsd / cantidadPorEmpaque;
        const subtotalUsd = item.cantidad * precioUnitarioUsd;
        
        // Buscar la venta asociada para obtener el tipo de cambio
        const ventaAsociada = ventasCompletas.find(v => v.id === item.venta_id);
        const tipoCambio = ventaAsociada?.tasa_cambio || 36.5; // Valor por defecto si no existe
        
        // Calcular subtotal en BS
        const subtotalBs = subtotalUsd * tipoCambio;
        
        productosAgrupados[item.producto_id].subtotal_usd += subtotalUsd;
        productosAgrupados[item.producto_id].subtotal_bs += subtotalBs;
      });
      
      // Convertir a array y ordenar por subtotal (mayor a menor)
      const productosArray = Object.values(productosAgrupados);
      productosArray.sort((a, b) => b.subtotal_bs - a.subtotal_bs);
      
      // Crear tarjetas para cada producto - MODIFICADO según la imagen
      productosArray.forEach(producto => {
        const card = document.createElement('div');
        card.className = 'producto-card';
        
        card.innerHTML = `
          <h3 class="producto-nombre">${producto.nombre}</h3>
          <table class="producto-tabla">
            <tr>
              <th>Marca</th>
              <td>${producto.marca}</td>
            </tr>
            <tr>
              <th>Cantidad Vendida</th>
              <td>${producto.cantidad}</td>
            </tr>
            <tr>
              <th>Subtotal USD</th>
              <td class="moneda-usd">$ ${producto.subtotal_usd.toFixed(2)}</td>
            </tr>
            <tr>
              <th>Subtotal BS</th>
              <td class="moneda-bs">Bs ${producto.subtotal_bs.toFixed(2)}</td>
            </tr>
          </table>
          <div class="producto-total">
            <div class="total-label">Total Vendido</div>
            <div class="total-value moneda-bs">Bs ${producto.subtotal_bs.toFixed(2)}</div>
          </div>
        `;
        
        productosGrid.appendChild(card);
      });
    }

    // Función para mostrar detalles de ventas en tabla
    function mostrarDetallesVentas() {
      const tablaVentas = document.getElementById('tablaVentas');
      tablaVentas.innerHTML = '';
      
      // Crear array de detalles con información de venta asociada
      const detallesConVenta = detallesVentas.map(detalle => {
        const venta = ventasCompletas.find(v => v.id === detalle.venta_id);
        return {
          ...detalle,
          venta: venta
        };
      });

      // Filtrar según los filtros seleccionados
      let detallesFiltrados = aplicarFiltros(detallesConVenta);
      
      // Crear filas de la tabla
      detallesFiltrados.forEach(item => {
        const fila = document.createElement('tr');
        
        // Obtener información del producto
        const productoInfo = productosMap[item.producto_id];
        const cantidadPorEmpaque = productoInfo?.cantidad_por_empaque || 1;
        const precioUsd = productoInfo?.precio_usd || 0;
        
        // Calcular precio unitario CORREGIDO: dividir precio_usd por cantidad_por_empaque
        const precioUnitarioUsd = precioUsd / cantidadPorEmpaque;
        const subtotalUsd = item.cantidad * precioUnitarioUsd;
        
        // Buscar la venta asociada para obtener el tipo de cambio
        const ventaAsociada = ventasCompletas.find(v => v.id === item.venta_id);
        const tipoCambio = ventaAsociada?.tasa_cambio || 36.5; // Valor por defecto si no existe
        
        // Calcular subtotal en BS
        const subtotalBs = subtotalUsd * tipoCambio;
        
        // Obtener método de pago
        const pagoAsociado = pagosVentas.find(p => p.venta_id === item.venta_id);
        const metodoPago = pagoAsociado?.metodo || 'Desconocido';
        
        fila.innerHTML = `
          <td>${formatearFecha(item.venta?.fecha)}</td>
          <td>${productoInfo?.nombre || 'Producto no encontrado'}</td>
          <td>${productoInfo?.marca || 'Sin marca'}</td>
          <td>${metodoPago}</td>
          <td>${item.cantidad}</td>
          <td class="moneda-usd">$ ${precioUnitarioUsd.toFixed(2)}</td>
          <td class="moneda-bs">Bs ${subtotalBs.toFixed(2)}</td>
          <td>
            <button class="btn-eliminar" data-id="${item.id}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tablaVentas.appendChild(fila);
      });
      
      // Agregar event listeners a los botones de eliminar
      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', function() {
          const detalleId = this.getAttribute('data-id');
          const detalle = detallesVentas.find(d => d.id == detalleId);
          
          if (detalle) {
            ventaAEliminar = detalle.venta_id;
            const modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            modal.show();
          }
        });
      });
    }

    // Función para aplicar filtros a los detalles
    function aplicarFiltros(detalles) {
      let filtrados = [...detalles];
      
      // Aplicar filtro por tipo de pago
      if (filtroActual !== 'all') {
        filtrados = filtrados.filter(item => {
          const pagoAsociado = pagosVentas.find(p => p.venta_id === item.venta_id);
          return pagoAsociado?.metodo === filtroActual;
        });
      }
      
      // Aplicar filtro por fecha
      if (filtroFechaTipo !== 'all') {
        let fechaInicio, fechaFin;
        
        switch(filtroFechaTipo) {
          case 'hoy':
            fechaInicio = inicioDelDia();
            fechaFin = finDelDia();
            break;
          case 'semana':
            fechaInicio = inicioDeSemana();
            fechaFin = finDeSemana();
            break;
          case 'mes':
            fechaInicio = inicioDeMes();
            fechaFin = finDeMes();
            break;
          case 'rango':
            if (fechaInicioRango && fechaFinRango) {
              fechaInicio = inicioDelDia(new Date(fechaInicioRango));
              fechaFin = finDelDia(new Date(fechaFinRango));
            }
            break;
        }
        
        if (fechaInicio && fechaFin) {
          filtrados = filtrados.filter(item => {
            const fechaVenta = new Date(item.venta?.fecha);
            return fechaVenta >= fechaInicio && fechaVenta <= fechaFin;
          });
        }
      }
      
      return filtrados;
    }

    // Función para eliminar una venta
    async function eliminarVenta() {
      if (!ventaAEliminar) return;
      
      try {
        // Eliminar detalles de venta asociados
        const { error: errorDetalles } = await supabaseClient
          .from('detalles_venta')
          .delete()
          .eq('venta_id', ventaAEliminar);
          
        if (errorDetalles) throw errorDetalles;
        
        // Eliminar pagos asociados
        const { error: errorPagos } = await supabaseClient
          .from('pagos_venta')
          .delete()
          .eq('venta_id', ventaAEliminar);
          
        if (errorPagos) throw errorPagos;
        
        // Eliminar la venta
        const { error: errorVenta } = await supabaseClient
          .from('ventas')
          .delete()
          .eq('id', ventaAEliminar);
          
        if (errorVenta) throw errorVenta;
        
        // Recargar datos
        await cargarDatos();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal'));
        modal.hide();
        
      } catch (error) {
        console.error('Error al eliminar venta:', error);
        alert('Error al eliminar la venta. Por favor, intenta nuevamente.');
      }
    }

    // Inicializar la aplicación cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar datos iniciales
      cargarDatos();
      
      // Configurar buscador
      const buscador = document.getElementById('buscadorVentas');
      buscador.addEventListener('input', function() {
        mostrarProductosAgrupados();
        mostrarDetallesVentas();
      });
      
      // Configurar filtros rápidos
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
          // Actualizar estado activo
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Aplicar filtro
          filtroActual = this.getAttribute('data-filter');
          mostrarProductosAgrupados();
          mostrarDetallesVentas();
        });
      });
      
      // Configurar filtros de fecha
      document.querySelectorAll('[data-fecha-filtro]').forEach(btn => {
        btn.addEventListener('click', function() {
          // Actualizar estado activo
          document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Aplicar filtro de fecha
          const filtro = this.getAttribute('data-fecha-filtro');
          
          if (filtro === 'all') {
            filtroFechaTipo = 'all';
          } else if (filtro === 'mes') {
            filtroFechaTipo = 'mes';
          }
          
          mostrarProductosAgrupados();
          mostrarDetallesVentas();
        });
      });
      
      // Configurar rango de fechas personalizado
      document.getElementById('aplicarRango').addEventListener('click', function() {
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        if (fechaInicio && fechaFin) {
          fechaInicioRango = fechaInicio;
          fechaFinRango = fechaFin;
          filtroFechaTipo = 'rango';
          
          // Actualizar estado activo
          document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
          
          mostrarProductosAgrupados();
          mostrarDetallesVentas();
        }
      });
      
      // Configurar rango de fechas personalizado (versión móvil)
      document.getElementById('aplicarRangoMobile').addEventListener('click', function() {
        const fechaInicio = document.getElementById('fechaInicioMobile').value;
        const fechaFin = document.getElementById('fechaFinMobile').value;
        
        if (fechaInicio && fechaFin) {
          fechaInicioRango = fechaInicio;
          fechaFinRango = fechaFin;
          filtroFechaTipo = 'rango';
          
          // Actualizar estado activo
          document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
          
          mostrarProductosAgrupados();
          mostrarDetallesVentas();
        }
      });
      
      // Configurar confirmación de eliminación
      document.getElementById('confirmarEliminarBtn').addEventListener('click', eliminarVenta);
    });
  </script>
</body>
</html>