<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Ventas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --verde-farmacia: #05642d;
      --fondo-oscuro: #1a1a1a;
      --texto-blanco: #ffffff;
      --azul-ventas: #1e88e5;
      --rojo-eliminar: #dc3545;
    }
    
    body {
      background-color: #000;
      color: var(--texto-blanco);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .container-mobile {
      max-width: 100%;
      padding: 15px;
    }

    .btn-submit {
      background-color: #05642d;
      color: #fff;
      padding: 10px 30px;
      border: none;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background-color: #cccccc;
      color: #000000;
      transform: translateY(-2px);
    }
    
    .logo-container {
      text-align: center;
      margin: 15px 0 25px;
    }
    
    .card-ventas {
      background-color: var(--fondo-oscuro);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .title-ventas {
      text-align: center;
      margin-bottom: 20px;
      color: var(--texto-blanco);
      font-size: 1.5rem;
    }
    
    .search-box {
      margin-bottom: 15px;
    }
    
    .search-input {
      width: 100%;
      padding: 10px 15px;
      background-color: #2a2a2a;
      border: 1px solid var(--verde-farmacia);
      border-radius: 5px;
      color: var(--texto-blanco);
    }
    
    .table-ventas {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .table-ventas th {
      background-color: var(--azul-ventas);
      color: white;
      padding: 12px 8px;
      text-align: left;
    }
    
    .table-ventas td {
      padding: 10px 8px;
      border-bottom: 1px solid #333;
    }
    
    .table-ventas tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    
    .table-ventas tr:hover {
      background-color: #333;
    }
    
    .btn-volver {
      display: block;
      width: 100%;
      background-color: #333;
      color: white;
      text-align: center;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      text-decoration: none;
    }
    
    .btn-volver:hover {
      background-color: #444;
      color: white;
    }
    
    /* Scroll horizontal para móviles */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Estilos para las tarjetas de resumen */
    .summary-cards {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-card {
      background-color: var(--fondo-oscuro);
      border-radius: 10px;
      padding: 15px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
    }

    .summary-icon {
      font-size: 2rem;
      margin-right: 15px;
      color: var(--azul-ventas);
    }

    .summary-content {
      flex: 1;
    }

    .summary-title {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 5px;
    }

    .summary-value {
      font-size: 1.3rem;
      font-weight: bold;
    }
    
    .summary-subvalue {
      font-size: 0.9rem;
      color: #aaa;
    }

    /* Filtros rápidos */
    .filtros-rapidos {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .filtros-fechas {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filtros-rapidos-fechas {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-filtro {
      background-color: #333;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .btn-filtro:hover {
      background-color: #444;
    }

    .btn-filtro.active {
      background-color: var(--azul-ventas);
      font-weight: bold;
    }
    
    .rango-fechas {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .fecha-input {
      background-color: #2a2a2a;
      border: 1px solid var(--verde-farmacia);
      border-radius: 5px;
      color: var(--texto-blanco);
      padding: 5px 10px;
    }
    
    .fecha-label {
      font-size: 0.9rem;
      color: #aaa;
    }

    /* Botón eliminar */
    .btn-eliminar {
      background-color: var(--rojo-eliminar);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .btn-eliminar:hover {
      background-color: #c82333;
    }

    /* Modal para detalles de venta */
    .modal-venta {
      color: var(--texto-blanco);
    }

    .modal-content {
      background-color: var(--fondo-oscuro);
    }

    .modal-header {
      border-bottom: 1px solid #333;
    }

    .modal-footer {
      border-top: 1px solid #333;
    }

    /* CSS adicional para la animación del spinner */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Pestañas para cambiar vista */
    .nav-tabs {
      border-bottom: 1px solid #444;
      margin-bottom: 20px;
    }

    .nav-tabs .nav-link {
      color: #aaa;
      border: none;
      border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link.active {
      color: var(--azul-ventas);
      background-color: transparent;
      border-bottom: 3px solid var(--azul-ventas);
    }

    .nav-tabs .nav-link:hover {
      color: white;
      border-color: #eee;
    }

    /* Tarjetas de productos - ESTILOS MODIFICADOS */
    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .producto-card {
      background-color: #2a2a2a;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
    }
    
    .producto-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .producto-nombre {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0 0 15px 0;
      text-align: center;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }
    
    .producto-tabla {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    
    .producto-tabla th {
      text-align: left;
      padding: 8px;
      background-color: #333;
    }
    
    .producto-tabla td {
      padding: 8px;
      border-bottom: 1px solid #444;
    }
    
    .producto-tabla tr:last-child td {
      border-bottom: none;
    }
    
    .producto-total {
      text-align: center;
      padding-top: 10px;
      border-top: 1px solid #444;
    }
    
    .total-label {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 5px;
    }
    
    .total-value {
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .moneda-usd {
      color: #17a2b8; /* Azul claro para dólares */
    }
    
    .moneda-bs {
      color: #28a745; /* Verde para bolívares */
    }
    
    /* Botón de imprimir reporte */
    .btn-imprimir {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-imprimir:hover {
      background-color: #5a6268;
    }

    .btn-imprimir-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
    }
    
    /* Ajustes para pantallas pequeñas */
    @media (max-width: 768px) {
      .productos-grid {
        grid-template-columns: 1fr;
      }
      
      .filtros-fechas {
        flex-direction: column;
      }
      
      .filtros-rapidos-fechas {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .rango-fechas {
        flex-direction: column;
        align-items: stretch;
      }
      
      .rango-fechas-horizontal {
        display: none;
      }
      
      .rango-fechas-vertical {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .producto-details {
        grid-template-columns: 1fr;
      }
      
      .table-ventas th, 
      .table-ventas td {
        padding: 8px 5px;
        font-size: 0.9rem;
      }
      
      .table-ventas th {
        font-size: 0.95rem;
      }
      
      .summary-card {
        min-width: 100%;
      }

      .btn-imprimir-container {
        justify-content: center;
      }
    }
    
    /* Para pantallas más grandes */
    @media (min-width: 769px) {
      .rango-fechas-vertical {
        display: none;
      }
      
      .rango-fechas-horizontal {
        display: flex;
        align-items: center;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container-mobile">
    <div class="row">
      <div class="col-12 text-center logo-container">
        <img alt="Logo" src="logo.png" class="img-fluid" height="150px" width="350px">
      </div>
    </div>
    
    <div class="card-ventas">
      <h2 class="title-ventas">REPORTE DE VENTAS</h2>
      
      <!-- Pestañas para cambiar vista -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab" aria-controls="productos" aria-selected="true">Ventas por Producto</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="detalles-tab" data-bs-toggle="tab" data-bs-target="#detalles" type="button" role="tab" aria-controls="detalles" aria-selected="false">Detalles de Ventas</button>
        </li>
      </ul>
      
      <div class="tab-content" id="myTabContent">
        <!-- Vista de productos -->
        <div class="tab-pane fade show active" id="productos" role="tabpanel" aria-labelledby="productos-tab">
          <!-- Tarjetas de resumen -->
          <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Total Ventas</div>
                <div class="summary-value" id="totalVentas">0</div>
              </div>
            </div>
            
            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Monto Total</div>
                <div class="summary-value moneda-usd" id="montoTotalUSD">$ 0.00</div>
                <div class="summary-subvalue moneda-bs" id="montoTotalBS">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-store"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Punto de Venta</div>
                <div class="summary-value moneda-bs" id="ventasPunto">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-money-bill"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Efectivo</div>
                <div class="summary-value moneda-bs" id="ventasEfectivo">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-mobile-alt"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Pago Móvil</div>
                <div class="summary-value moneda-bs" id="ventasMovil">Bs 0.00</div>
              </div>
            </div>

            <div class="summary-card">
              <div class="summary-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="summary-content">
                <div class="summary-title">Dólares</div>
                <div class="summary-value moneda-usd" id="ventasDolares">$ 0.00</div>
              </div>
            </div>
          </div>

          <!-- Filtros de fechas -->
          <div class="filtros-fechas" id="filtrosFechas" style="display: none;">
            <div class="filtros-rapidos-fechas">
              <button class="btn-filtro active" data-fecha-filtro="all">Todas las fechas</button>
              <button class="btn-filtro" data-fecha-filtro="semana">Esta semana</button>
              <button class="btn-filtro" data-fecha-filtro="mes">Este mes</button>
            </div>
            
            <div class="rango-fechas">
              <!-- Versión horizontal para escritorio -->
              <div class="rango-fechas-horizontal">
                <span class="fecha-label">Rango personalizado:</span>
                <input type="date" class="fecha-input" id="fechaInicio">
                <span class="fecha-label">a</span>
                <input type="date" class="fecha-input" id="fechaFin">
                <button class="btn-filtro" id="aplicarRango">Aplicar</button>
              </div>
              
              <!-- Versión vertical para móviles -->
              <div class="rango-fechas-vertical">
                <span class="fecha-label">Rango personalizado:</span>
                <input type="date" class="fecha-input mb-2" id="fechaInicioMobile" placeholder="Fecha inicio">
                <span class="fecha-label">a</span>
                <input type="date" class="fecha-input mb-2" id="fechaFinMobile" placeholder="Fecha fin">
                <button class="btn-filtro" id="aplicarRangoMobile">Aplicar</button>
              </div>
            </div>
          </div>

          <!-- Filtros rápidos -->
          <div class="filtros-rapidos" id="filtrosRapidos" style="display: none;">
            <button class="btn-filtro active" data-filter="all">Todas</button>
            <button class="btn-filtro" data-filter="Punto de venta">Punto de Venta</button>
            <button class="btn-filtro" data-filter="Efectivo">Efectivo</button>
            <button class="btn-filtro" data-filter="Pago móvil">Pago Móvil</button>
            <button class="btn-filtro" data-filter="Dólares">Dólares</button>
          </div>
          
          <!-- Botón para imprimir reporte -->
          <div class="btn-imprimir-container">
            <button class="btn-imprimir" id="btnImprimir">
              <i class="fas fa-print"></i> Imprimir Reporte
            </button>
          </div>
          
          <div class="search-box">
            <input type="text" class="search-input" placeholder="Buscar por producto o marca..." id="buscadorVentas">
          </div>
          
          <!-- Loading indicator -->
          <div id="loadingIndicator" class="text-center" style="padding: 20px;">
            <svg style="animation: spin 1s linear infinite; display: inline-block; width: 24px; height: 24px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Cargando ventas...</p>
          </div>
          
          <!-- Grid de productos -->
          <div class="productos-grid" id="productosGrid" style="display: none;">
            <!-- Las tarjetas de productos se cargarán aquí dinámicamente -->
          </div>
        </div>
        
        <!-- Vista de detalles de ventas -->
        <div class="tab-pane fade" id="detalles" role="tabpanel" aria-labelledby="detalles-tab">
          <div class="table-responsive" id="tableContainer" style="display: none;">
            <table class="table-ventas">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Producto</th>
                  <th>Marca</th>
                  <th>Tipo Pago</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tablaVentas">
                <!-- Los datos se cargarán aquí dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Mensaje cuando no hay ventas -->
      <div id="emptyMessage" class="text-center" style="display: none; padding: 40px;">
        <p>No hay ventas registradas.</p>
      </div>
      
      <!-- Mensaje de error -->
      <div id="errorMessage" class="text-center" style="display: none; padding: 40px; color: #ff6b6b;">
        <p>Error al cargar ventas. Por favor, recarga la página.</p>
      </div>
      <br>
      <div class="text-center">
         <a class="btn btn-submit btn-lg" href="../inventario/index.html">Volver al Menú</a>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar eliminación -->
  <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content modal-venta">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmarEliminarModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta venta? Esta acción no se puede deshacer.</p>
          <p><strong>Nota:</strong> Se eliminarán todos los detalles asociados a esta venta.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmarEliminarBtn">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Incluir Supabase SDK y Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Configuración de Supabase
    const SUPABASE_URL = 'https://rirfvhvlmytnpqkcpxbx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcmZ2aHZsbXl0bnBxa2NweGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODE2NDUsImV4cCI6MjA3MjA1NzY0NX0.5JLGuOIWNvKIESJG26JLOgRVCu0jVoH0ELZjQ63gV48';
     
    // Inicializar Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variable global para almacenar datos
    let ventasCompletas = [];
    let detallesVentas = [];
    let pagosVentas = [];
    let productosMap = {};
    let filtroActual = 'all';
    let filtroFechaTipo = 'all'; // all, hoy, semana, mes, rango
    let fechaInicioRango = null;
    let fechaFinRango = null;
    let ventaAEliminar = null;
    let textoBusqueda = ''; // Variable para almacenar el texto de búsqueda

    // Función para formatear fecha (solo fecha, sin hora) - CORREGIDA
    function formatearFecha(fechaStr) {
      // Ajustar por zona horaria: añadir el offset para evitar el problema de un día menos
      const fecha = new Date(fechaStr);
      fecha.setMinutes(fecha.getMinutes() + fecha.getTimezoneOffset());
      
      const dia = fecha.getDate().toString().padStart(2, '0');
      const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
      const año = fecha.getFullYear();
      return `${dia}/${mes}/${año}`;
    }

    // Función para obtener el inicio del día
    function inicioDelDia(fecha = new Date()) {
      const inicio = new Date(fecha);
      inicio.setHours(0, 0, 0, 0);
      return inicio;
    }

    // Función para obtener el fin del día
    function finDelDia(fecha = new Date()) {
      const fin = new Date(fecha);
      fin.setHours(23, 59, 59, 999);
      return fin;
    }

    // Función para obtener el inicio de la semana (lunes)
    function inicioDeSemana() {
      const hoy = new Date();
      const dia = hoy.getDay();
      const diff = hoy.getDate() - dia + (dia === 0 ? -6 : 1); // Ajuste para que la semana empiece en lunes
      return inicioDelDia(new Date(hoy.setDate(diff)));
    }

    // Función para obtener el fin de la semana (domingo)
    function finDeSemana() {
      const inicio = inicioDeSemana();
      const fin = new Date(inicio);
      fin.setDate(inicio.getDate() + 6);
      return finDelDia(fin);
    }

    // Función para obtener el inicio del mes
    function inicioDeMes() {
      const hoy = new Date();
      return inicioDelDia(new Date(hoy.getFullYear(), hoy.getMonth(), 1));
    }

    // Función para obtener el fin del mes
    function finDeMes() {
      const hoy = new Date();
      return finDelDia(new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0));
    }

    // Función para filtrar por texto de búsqueda
    function filtrarPorTexto(detalles) {
      if (!textoBusqueda) return detalles;
      
      const texto = textoBusqueda.toLowerCase().trim();
      return detalles.filter(item => {
        const productoInfo = productosMap[item.producto_id];
        if (!productoInfo) return false;
        
        return productoInfo.nombre.toLowerCase().includes(texto) || 
               (productoInfo.marca && productoInfo.marca.toLowerCase().includes(texto));
      });
    }

    // Función para filtrar ventas por fecha
    function filtrarVentasPorFecha(ventas) {
      const ahora = new Date();
      
      switch (filtroFechaTipo) {
        case 'hoy':
          const inicioHoy = inicioDelDia(ahora);
          const finHoy = finDelDia(ahora);
          return ventas.filter(venta => {
            const fechaVenta = new Date(venta.fecha);
            return fechaVenta >= inicioHoy && fechaVenta <= finHoy;
          });
          
        case 'semana':
          const inicioSemana = inicioDeSemana();
          const finSemana = finDeSemana();
          return ventas.filter(venta => {
            const fechaVenta = new Date(venta.fecha);
            return fechaVenta >= inicioSemana && fechaVenta <= finSemana;
          });
          
        case 'mes':
          const inicioMes = inicioDeMes();
          const finMes = finDeMes();
          return ventas.filter(venta => {
            const fechaVenta = new Date(venta.fecha);
            return fechaVenta >= inicioMes && fechaVenta <= finMes;
          });
          
        case 'rango':
          if (!fechaInicioRango || !fechaFinRango) return ventas;
          
          const inicioRango = inicioDelDia(new Date(fechaInicioRango));
          const finRango = finDelDia(new Date(fechaFinRango));
          
          return ventas.filter(venta => {
            const fechaVenta = new Date(venta.fecha);
            return fechaVenta >= inicioRango && fechaVenta <= finRango;
          });
          
        default: // 'all'
          return ventas;
      }
    }

    // Función para calcular estadísticas de ventas
   // Función para calcular estadísticas de ventas - VERSIÓN CORREGIDA
function calcularEstadisticasVentas(detallesFiltrados, pagosFiltrados) {
  // Calcular total de ventas
  const totalVentas = new Set(detallesFiltrados.map(d => d.venta_id)).size;
  
  // Calcular montos totales (USD y BS) desde los detalles
  const montoTotalUsdDetalles = detallesFiltrados.reduce((acc, d) => acc + (d.subtotal_usd || 0), 0);
  const montoTotalBsDetalles = detallesFiltrados.reduce((acc, d) => acc + (d.subtotal_bs || 0), 0);
  
  // Calcular montos por tipo de pago
  let ventasPuntoBs = 0;
  let ventasEfectivoBs = 0;
  let ventasMovilBs = 0;
  let ventasDolaresUsd = 0;
  
  // CORRECCIÓN: También sumar los pagos en dólares al monto total en USD
  let montoTotalUsdPagos = 0;

  pagosFiltrados.forEach(pago => {
    switch (pago.metodo) {
      case 'Punto de venta':
        ventasPuntoBs += pago.monto_bs || 0;
        break;
      case 'Efectivo':
        ventasEfectivoBs += pago.monto_bs || 0;
        break;
      case 'Pago móvil':
        ventasMovilBs += pago.monto_bs || 0;
        break;
      case 'Dólares':
        ventasDolaresUsd += pago.monto_usd || 0;
        // CORRECCIÓN: Sumar los pagos en dólares al total en USD
        montoTotalUsdPagos += pago.monto_usd || 0;
        break;
    }
  });
  
  // CORRECCIÓN: El monto total en USD debe incluir tanto los detalles como los pagos en dólares
  const montoTotalUsd = montoTotalUsdDetalles + montoTotalUsdPagos;
  
  return {
    totalVentas,
    montoTotalUsd, // Ahora incluye correctamente los pagos en dólares
    montoTotalBs: montoTotalBsDetalles,
    ventasPuntoBs,
    ventasEfectivoBs,
    ventasMovilBs,
    ventasDolaresUsd
  };
}

    // Función para actualizar las tarjetas de resumen
    function actualizarResumenVentas(estadisticas) {
      const fmtUSD = x => `$ ${Number(x).toFixed(2)}`;
      const fmtBS = x => `Bs ${Number(x).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

      document.getElementById('totalVentas').textContent = estadisticas.totalVentas;
      document.getElementById('montoTotalUSD').textContent = fmtUSD(estadisticas.montoTotalUsd);
      document.getElementById('montoTotalBS').textContent = fmtBS(estadisticas.montoTotalBs);
      document.getElementById('ventasPunto').textContent = fmtBS(estadisticas.ventasPuntoBs);
      document.getElementById('ventasEfectivo').textContent = fmtBS(estadisticas.ventasEfectivoBs);
      document.getElementById('ventasMovil').textContent = fmtBS(estadisticas.ventasMovilBs);
      document.getElementById('ventasDolares').textContent = fmtUSD(estadisticas.ventasDolaresUsd);
    }

    async function cargarDatos() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const tableContainer   = document.getElementById('tableContainer');
      const productosGrid    = document.getElementById('productosGrid');
      const emptyMessage     = document.getElementById('emptyMessage');
      const errorMessage     = document.getElementById('errorMessage');
      const summaryCards     = document.getElementById('summaryCards');
      const filtrosRapidos   = document.getElementById('filtrosRapidos');
      const filtrosFechas    = document.getElementById('filtrosFechas');

      try {
        // Mostrar loading
        loadingIndicator.style.display = 'block';
        tableContainer.style.display   = 'none';
        productosGrid.style.display    = 'none';
        emptyMessage.style.display     = 'none';
        errorMessage.style.display     = 'none';
        summaryCards.style.display     = 'none';
        filtrosRapidos.style.display   = 'none';
        filtrosFechas.style.display    = 'none';

        // Obtener datos en paralelo
        const [productosResponse, ventasResponse, detallesResponse, pagosResponse] = await Promise.all([
          supabaseClient.from('productos').select('id, nombre, marca, cantidad_por_empaque, precio_venta_1_usd'),
          supabaseClient.from('ventas').select('*').order('fecha', { ascending: false }),
          supabaseClient.from('detalles_venta').select('*'),
          supabaseClient.from('pagos_venta').select('*')
        ]);

        if (productosResponse.error) throw productosResponse.error;
        if (ventasResponse.error)   throw ventasResponse.error;
        if (detallesResponse.error) throw detallesResponse.error;
        if (pagosResponse.error)    throw pagosResponse.error;

        // Crear mapa de productos
        productosMap = {};
        productosResponse.data.forEach(producto => {
          productosMap[producto.id] = {
            nombre: producto.nombre,
            marca: producto.marca || 'Sin marca',
            cantidad_por_empaque: producto.cantidad_por_empaque || 1,
            precio_usd: producto.precio_venta_1_usd || 0
          };
        });

        // Guardar datos globales
        ventasCompletas = ventasResponse.data || [];
        detallesVentas  = detallesResponse.data || [];
        pagosVentas     = pagosResponse.data || [];

        // Ordenar ventas (más recientes primero)
        ventasCompletas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        // Aplicar filtros iniciales
        aplicarFiltrosYActualizarVistas();

        summaryCards.style.display = 'flex';
        filtrosRapidos.style.display = 'flex';
        filtrosFechas.style.display  = 'flex';
        loadingIndicator.style.display = 'none';

      } catch (error) {
        console.error('Error al cargar datos:', error);
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'block';
      }
    }

    // Función para aplicar filtros y actualizar vistas sin recargar datos
    function aplicarFiltrosYActualizarVistas() {
      // Filtrar ventas por fecha
      const ventasFiltradas = filtrarVentasPorFecha(ventasCompletas);
      
      // Filtrar detalles y pagos según las ventas filtradas
      const ventasFiltradasIds = ventasFiltradas.map(v => v.id);
      const detallesFiltrados = detallesVentas.filter(d => ventasFiltradasIds.includes(d.venta_id));
      const pagosFiltrados = pagosVentas.filter(p => ventasFiltradasIds.includes(p.venta_id));
      
      // Calcular estadísticas con los datos filtrados
      const estadisticas = calcularEstadisticasVentas(detallesFiltrados, pagosFiltrados);
      
      // Actualizar tarjetas de resumen
      actualizarResumenVentas(estadisticas);

      // Mostrar detalles si existen ventas
      if (detallesVentas.length > 0) {
        mostrarProductosAgrupados(detallesFiltrados);
        document.getElementById('productosGrid').style.display = 'grid';
        mostrarDetallesVentas(detallesFiltrados);
        document.getElementById('tableContainer').style.display = 'block';
        document.getElementById('emptyMessage').style.display = 'none';
      } else {
        document.getElementById('emptyMessage').style.display = 'block';
        document.getElementById('productosGrid').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'none';
      }
    }

    function mostrarProductosAgrupados(detallesFiltrados) {
      const productosGrid = document.getElementById('productosGrid');
      productosGrid.innerHTML = '';

      // Crear array de detalles con información de venta asociada
      const detallesConVenta = detallesFiltrados.map(detalle => {
        const venta = ventasCompletas.find(v => v.id === detalle.venta_id);
        return { ...detalle, venta };
      });

      // Filtrar según los filtros seleccionados
      let detallesFiltradosConFiltros = aplicarFiltros(detallesConVenta);
      
      // Aplicar filtro de búsqueda por texto
      detallesFiltradosConFiltros = filtrarPorTexto(detallesFiltradosConFiltros);

      // Agrupar por producto
      const productosAgrupados = {};

      detallesFiltradosConFiltros.forEach(item => {
        if (!productosAgrupados[item.producto_id]) {
          productosAgrupados[item.producto_id] = {
            nombre: productosMap[item.producto_id]?.nombre,
            marca: productosMap[item.producto_id]?.marca || 'Sin marca',
            id: item.producto_id,
            unidades: 0,
            subtotal_bs: 0,
            subtotal_usd: 0
          };
        }

        productosAgrupados[item.producto_id].unidades += item.unidades || 0;
        productosAgrupados[item.producto_id].subtotal_usd += item.subtotal_usd || 0;
        productosAgrupados[item.producto_id].subtotal_bs  += item.subtotal_bs  || 0;
      });

      // Convertir a array y ordenar por subtotal (mayor a menor)
      const productosArray = Object.values(productosAgrupados);
      productosArray.sort((a, b) => b.subtotal_bs - a.subtotal_bs);

      // Crear tarjetas para cada producto
      productosArray.forEach(producto => {
        const card = document.createElement('div');
        card.className = 'producto-card';

        card.innerHTML = `
          <h3 class="producto-nombre">${producto.nombre}</h3>
          <table class="producto-tabla">
            <tr>
              <th>Marca</th>
              <td>${producto.marca}</td>
            </tr>
            <tr>
              <th>Unidades Vendidas</th>
              <td>${producto.unidades}</td>
            </tr>
            <tr>
              <th>Total USD</th>
              <td class="moneda-usd">$ ${producto.subtotal_usd.toFixed(2)}</td>
            </tr>
            <tr>
              <th>Total Bs</th>
              <td class="moneda-bs">Bs ${producto.subtotal_bs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            </tr>
          </table>
          <div class="producto-total">
            <div class="total-label">Total Vendido</div>
            <div class="total-value moneda-bs">Bs ${producto.subtotal_bs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
          </div>
        `;

        productosGrid.appendChild(card);
      });
    }

    function mostrarDetallesVentas(detallesFiltrados) {
      const tablaVentas = document.getElementById('tablaVentas');
      tablaVentas.innerHTML = '';
      
      // Crear array de detalles con información de venta asociada
      const detallesConVenta = detallesFiltrados.map(detalle => {
        const venta = ventasCompletas.find(v => v.id === detalle.venta_id);
        return { ...detalle, venta };
      });
      
      // Filtrar según los filtros seleccionados
      let detallesFiltradosConFiltros = aplicarFiltros(detallesConVenta);
      
      // Aplicar filtro de búsqueda por texto
      detallesFiltradosConFiltros = filtrarPorTexto(detallesFiltradosConFiltros);
      
      // Ordenar por fecha (más recientes primero)
      detallesFiltradosConFiltros.sort((a, b) => new Date(b.venta.fecha) - new Date(a.venta.fecha));
      
      // Mostrar en la tabla
      detallesFiltradosConFiltros.forEach(item => {
        const productoInfo = productosMap[item.producto_id];
        if (!productoInfo) return;
        
        const fila = document.createElement('tr');
        
        // Determinar la moneda para mostrar el subtotal
        const esDolares = item.venta.tipo_pago === 'Dólares';
        const monedaClass = esDolares ? 'moneda-usd' : 'moneda-bs';
        const subtotalFormateado = esDolares ? 
          `$ ${item.subtotal_usd.toFixed(2)}` : 
          `Bs ${item.subtotal_bs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        fila.innerHTML = `
          <td>${formatearFecha(item.venta.fecha)}</td>
          <td>${productoInfo.nombre}</td>
          <td>${productoInfo.marca}</td>
          <td>${item.venta.tipo_pago}</td>
          <td>${item.unidades}</td>
          <td class="moneda-usd">$ ${(item.subtotal_usd / item.unidades).toFixed(2)}</td>
          <td class="${monedaClass}">${subtotalFormateado}</td>
          <td>
            <button class="btn-eliminar" data-venta-id="${item.venta_id}">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        
        tablaVentas.appendChild(fila);
      });
      
      // Agregar event listeners a los botones de eliminar
      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', () => {
          const ventaId = btn.getAttribute('data-venta-id');
          mostrarModalConfirmacion(ventaId);
        });
      });
    }
    
    function aplicarFiltros(detalles) {
      // Aplicar filtro de tipo de pago
      if (filtroActual !== 'all') {
        return detalles.filter(item => item.venta.tipo_pago === filtroActual);
      }
      
      return detalles;
    }
    
    function mostrarModalConfirmacion(ventaId) {
      ventaAEliminar = ventaId;
      const modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
      modal.show();
    }
    
    async function eliminarVenta() {
      if (!ventaAEliminar) return;
      
      try {
        // Eliminar detalles de venta
        const { error: errorDetalles } = await supabaseClient
          .from('detalles_venta')
          .delete()
          .eq('venta_id', ventaAEliminar);
          
        if (errorDetalles) throw errorDetalles;
        
        // Eliminar pagos de venta
        const { error: errorPagos } = await supabaseClient
          .from('pagos_venta')
          .delete()
          .eq('venta_id', ventaAEliminar);
          
        if (errorPagos) throw errorPagos;
        
        // Eliminar venta
        const { error: errorVenta } = await supabaseClient
          .from('ventas')
          .delete()
          .eq('id', ventaAEliminar);
          
        if (errorVenta) throw errorVenta;
        
        // Recargar datos
        await cargarDatos();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal'));
        modal.hide();
        
      } catch (error) {
        console.error('Error al eliminar venta:', error);
        alert('Error al eliminar la venta. Por favor, inténtalo de nuevo.');
      }
    }

    // Función para generar el reporte en PDF
    function generarReportePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Obtener ventas filtradas por fecha
      const ventasFiltradas = filtrarVentasPorFecha(ventasCompletas);
      
      // Filtrar detalles y pagos según las ventas filtradas
      const ventasFiltradasIds = ventasFiltradas.map(v => v.id);
      const detallesFiltrados = detallesVentas.filter(d => ventasFiltradasIds.includes(d.venta_id));
      const pagosFiltrados = pagosVentas.filter(p => ventasFiltradasIds.includes(p.venta_id));
      
      // Calcular estadísticas con los datos filtrados
      const estadisticas = calcularEstadisticasVentas(detallesFiltrados, pagosFiltrados);
      
      // Título del reporte
      doc.setFontSize(18);
      doc.text('Reporte de Ventas - Rey Sacerdote', 105, 15, { align: 'center' });
      
      // Información del rango de fechas
      doc.setFontSize(12);
      let textoFecha = 'Todas las fechas';
      
      if (filtroFechaTipo === 'hoy') {
        textoFecha = 'Hoy';
      } else if (filtroFechaTipo === 'semana') {
        textoFecha = 'Esta semana';
      } else if (filtroFechaTipo === 'mes') {
        textoFecha = 'Este mes';
      } else if (fechaInicioRango && fechaFinRango) {
        textoFecha = `Desde ${formatearFecha(fechaInicioRango)} hasta ${formatearFecha(fechaFinRango)}`;
      }
      
      doc.text(`Fecha: ${textoFecha}`, 105, 25, { align: 'center' });
      
      // Resumen de ventas
      doc.setFontSize(14);
      doc.text('Resumen de Ventas', 14, 40);
      
      doc.setFontSize(12);
      doc.text(`Total de ventas: ${estadisticas.totalVentas}`, 14, 50);
      doc.text(`Monto total (USD): $ ${estadisticas.montoTotalUsd.toFixed(2)}`, 14, 60);
      doc.text(`Monto total (BS): Bs ${estadisticas.montoTotalBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 14, 70);
      
      // Detalles de ventas por tipo de pago
      doc.text('Ventas por tipo de pago:', 14, 85);
      doc.text(`Punto de Venta: Bs ${estadisticas.ventasPuntoBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, 95);
      doc.text(`Efectivo: Bs ${estadisticas.ventasEfectivoBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, 105);
      doc.text(`Pago Móvil: Bs ${estadisticas.ventasMovilBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, 115);
      doc.text(`Dólares: $ ${estadisticas.ventasDolaresUsd.toFixed(2)}`, 20, 125);
      
      // Tabla de ventas detalladas
      doc.setFontSize(14);
      doc.text('Detalles de Ventas', 14, 140);
      
      // Preparar datos para la tabla
      const detallesConInfo = detallesFiltrados.map(detalle => {
        const venta = ventasCompletas.find(v => v.id === detalle.venta_id);
        const productoInfo = productosMap[detalle.producto_id];
        
        // Determinar la moneda para mostrar el subtotal
        const esDolares = venta.tipo_pago === 'Dólares';
        const subtotalFormateado = esDolares ? 
          `$ ${detalle.subtotal_usd.toFixed(2)}` : 
          `Bs ${detalle.subtotal_bs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        return {
          fecha: venta.fecha,
          producto: productoInfo?.nombre || 'Producto no encontrado',
          marca: productoInfo?.marca || 'Sin marca',
          tipoPago: venta.tipo_pago,
          cantidad: detalle.unidades,
          precioUnitario: (detalle.subtotal_usd / detalle.unidades).toFixed(2),
          subtotal: subtotalFormateado
        };
      });
      
      // Generar tabla
      doc.autoTable({
        startY: 145,
        head: [['Fecha', 'Producto', 'Marca', 'Tipo Pago', 'Cantidad', 'Precio Unit.', 'Subtotal']],
        body: detallesConInfo.map(item => [
          formatearFecha(item.fecha),
          item.producto,
          item.marca,
          item.tipoPago,
          item.cantidad,
          `$ ${item.precioUnitario}`,
          item.subtotal
        ]),
        theme: 'grid',
        headStyles: {
          fillColor: [30, 136, 229]
        }
      });
      
      // Guardar el PDF
      const fechaReporte = new Date().toISOString().slice(0, 10);
      doc.save(`reporte_ventas_${fechaReporte}.pdf`);
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Cargar datos iniciales
      cargarDatos();
      
      // Event listeners para filtros rápidos
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Actualizar estado activo
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Actualizar filtro
          filtroActual = btn.getAttribute('data-filter');
          
          // Aplicar filtros y actualizar vistas sin recargar datos
          aplicarFiltrosYActualizarVistas();
        });
      });
      
      // Event listeners para filtros de fecha
      document.querySelectorAll('[data-fecha-filtro]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Actualizar estado activo
          document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Actualizar filtro
          const filtro = btn.getAttribute('data-fecha-filtro');
          if (filtro === 'rango') {
            // Si es rango, no cambiamos hasta que se aplique
            return;
          }
          
          filtroFechaTipo = filtro;
          fechaInicioRango = null;
          fechaFinRango = null;
          
          // Aplicar filtros y actualizar vistas sin recargar datos
          aplicarFiltrosYActualizarVistas();
        });
      });
      
      // Event listeners para rango de fechas
      document.getElementById('aplicarRango').addEventListener('click', () => {
        const inicio = document.getElementById('fechaInicio').value;
        const fin = document.getElementById('fechaFin').value;
        
        if (!inicio || !fin) {
          alert('Por favor, selecciona ambas fechas.');
          return;
        }
        
        fechaInicioRango = inicio;
        fechaFinRango = fin;
        filtroFechaTipo = 'rango';
        
        // Actualizar estado activo
        document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
        
        // Aplicar filtros y actualizar vistas sin recargar datos
        aplicarFiltrosYActualizarVistas();
      });
      
      document.getElementById('aplicarRangoMobile').addEventListener('click', () => {
        const inicio = document.getElementById('fechaInicioMobile').value;
        const fin = document.getElementById('fechaFinMobile').value;
        
        if (!inicio || !fin) {
          alert('Por favor, selecciona ambas fechas.');
          return;
        }
        
        fechaInicioRango = inicio;
        fechaFinRango = fin;
        filtroFechaTipo = 'rango';
        
        // Actualizar estado activo
        document.querySelectorAll('[data-fecha-filtro]').forEach(b => b.classList.remove('active'));
        
        // Aplicar filtros y actualizar vistas sin recargar datos
        aplicarFiltrosYActualizarVistas();
      });
      
      // Event listener para confirmar eliminación
      document.getElementById('confirmarEliminarBtn').addEventListener('click', eliminarVenta);
      
      // Event listener para el buscador
      document.getElementById('buscadorVentas').addEventListener('input', (e) => {
        textoBusqueda = e.target.value;
        
        // Aplicar filtros y actualizar vistas sin recargar datos
        aplicarFiltrosYActualizarVistas();
      });
      
      // Event listener para cambio de pestaña
      document.getElementById('detalles-tab').addEventListener('click', () => {
        // Aplicar filtros y actualizar vistas sin recargar datos
        aplicarFiltrosYActualizarVistas();
      });
      
      document.getElementById('productos-tab').addEventListener('click', () => {
        // Aplicar filtros y actualizar vistas sin recargar datos
        aplicarFiltrosYActualizarVistas();
      });
      
      // Event listener para el botón de imprimir
      document.getElementById('btnImprimir').addEventListener('click', generarReportePDF);
    });
  </script>
</body>
</html>