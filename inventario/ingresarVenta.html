<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        #info-mayor {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #3105f1;
            color: white;
        }

        #info-mayor small {
            color: #ffffff !important;
        }

        #info-mayor .text-muted {
            color: #ffffff !important;
        }

        #cantidad {
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            color: #ffffff !important;
        }

        #cantidad:focus {
            background-color: #2a2a2a !important;
            border-color: #041fbd !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25) !important;
        }

        #cantidad:disabled {
            background-color: #333333 !important;
            color: #888888 !important;
            border-color: #555555 !important;
        }

        input[type="number"] {
            width: 70px;
            text-align: center;
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            color: #ffffff !important;
        }

        input[type="number"]:focus {
            background-color: #2a2a2a !important;
            border-color: #041fbd !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25) !important;
        }

        input[type="number"]:disabled {
            background-color: #333333 !important;
            color: #888888 !important;
            border-color: #555555 !important;
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .logo-container {
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .enlace {
            text-align: center;
            display: block;
            text-decoration: none;
        }

        .enlace:hover {
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .form-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-control, .form-select {
            background-color: #2a2a2a;
            border: 1px solid #3105f1;
            color: white;
        }

        .form-control:focus, .form-select:focus {
            background-color: #2a2a2a;
            border-color: #041fbd;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25);
        }

        .btn-principal {
            background-color: #3105f1;
            color: #fff;
            padding: 12px 40px;
            border: none;
            font-size: 1.1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .btn-principal:hover {
            background-color: #041fbd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-principal:active {
            transform: translateY(0);
        }

        .btn-danger {
            background-color: #dc3545;
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-danger:active {
            transform: translateY(0);
        }

        .table-carrito {
            color: white;
            width: 100%;
        }

        .table-carrito thead th {
            background-color: #3105f1;
            border-color: #041fbd;
            padding: 10px 8px;
        }

        .table-carrito tbody td {
            padding: 8px;
            vertical-align: middle;
        }

        .table-carrito tbody tr {
            background-color: #2a2a2a;
        }

        .table-carrito tbody tr:nth-child(even) {
            background-color: #333333;
        }

        .total-container {
            background-color: #3105f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .select2-container--default .select2-selection--single {
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            height: 38px;
            color: white !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: white !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: white transparent transparent transparent !important;
        }
        
        .select2-container--default .select2-results__option {
            background-color: #3105f1 !important;
            color: white !important;
            padding: 8px 12px !important;
        }
        
        .select2-container--default .select2-results__option--highlighted {
            background-color: #0648d6 !important;
        }
        
        .select2-dropdown {
            background-color: #3105f1 !important;
            border: 1px solid #034d21 !important;
        }

        .form-control:disabled, .form-select:disabled {
            background-color: #333333;
            cursor: not-allowed;
            border-color: #555555;
        }

        .metodo-pago {
            background-color: #2a2a2a;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #3105f1;
        }
        
        .metodo-pago-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-pago {
            font-weight: bold;
            color: #ffffff;
            text-align: right;
        }
        
        .restante-pendiente {
            font-size: 0.9rem;
            color: #ffcc00;
        }
        
        .pago-completado {
            color: #00cc66;
        }

        .detalle-unidades {
            font-size: 0.85rem;
            color: #cccccc;
            display: block;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            .table-carrito thead th, 
            .table-carrito tbody td {
                padding: 6px 4px;
                font-size: 0.9rem;
            }
            
            .btn-principal {
                padding: 10px 30px;
                font-size: 1rem;
            }
            
            .btn-danger {
                padding: 5px 10px;
                font-size: 0.9rem;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-12 text-center logo-container">
          <img alt="Logo" src="logo.png" class="img-fluid" height="150px" width="350px">
        </div>
    </div>

    <!-- Formulario para agregar productos -->
    <div class="form-container">
      <h3 class="text-center mb-3">INGRESAR VENTA</h3>
      <form id="form-agregar-producto">
        <div class="row g-2">
          <!-- Tasa de Cambio (movido aquÃ­ desde abajo) -->
          <div class="col-md-3">
            <label class="form-label">Tasa de Cambio (BS a USD)</label>
            <input type="number" step="1" min="1" class="form-control" id="tasa-cambio" value="140" required>
          </div>
          
          <!-- Producto -->
          <div class="col-md-3">
            <label class="form-label">Producto</label>
            <select class="form-control js-product-search" id="producto" required>
              <option value="">Buscar producto...</option>
            </select>
          </div>
          
          <!-- Tipo de Venta -->
          <div class="col-md-2">
            <label class="form-label">Tipo de Venta</label>
            <select class="form-select" id="tipo-venta" required disabled>
              <option value="">Seleccione</option>
              <option value="detal">Al Detal</option>
              <option value="mayor">Al Mayor</option>
            </select>
          </div>
          
          <!-- Precio Unitario (Selector) -->
          <div class="col-md-2">
            <label class="form-label">Precio</label>
            <select class="form-select" id="precio-selector" required disabled>
              <option value="">Seleccione precio</option>
            </select>
          </div>
          
          <!-- Unidad -->
          <div class="col-md-2">
            <label class="form-label">Unidad</label>
            <input type="text" class="form-control" id="unidad" readonly placeholder="Seleccione precio">
          </div>
          
          <!-- Cantidad -->
          <div class="col-md-2">
            <label class="form-label">Cantidad</label>
            <input type="number" min="1" value="1" class="form-control" id="cantidad" required disabled>
          </div>
        </div>
        
        <!-- InformaciÃ³n adicional para venta al mayor -->
        <div class="row g-2 mt-2" id="info-mayor" style="display: none;">
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> 
              <span id="info-empaque">Cada paca contiene 0 unidades</span>
            </small>
          </div>
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-calculator"></i> 
              <span id="total-unidades">Total: 0 unidades</span>
            </small>
          </div>
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-currency-dollar"></i> 
              <span id="subtotal-preview">Subtotal: USD 0.00 (BS 0.00)</span>
            </small>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-principal" id="btn-agregar" disabled>
            <i class="bi bi-cart-plus"></i> AGREGAR
          </button>
        </div>
      </form>
    </div>

    <!-- Carrito de compras -->
    <div class="card-container">
      <h3 class="text-center mb-3">CARRITO DE COMPRAS</h3>
      <div class="table-responsive">
        <table class="table table-carrito">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Tipo</th>
              <th>Cantidad</th>
              <th>Unidades</th>
              <th>P. Unit.</th>
              <th>Subtotal</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="carrito-body">
            <tr>
              <td colspan="7" class="text-center text-muted">No hay productos en el carrito</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="total-container">
        <div class="row">
          <div class="col-md-6">
            <h5 class="mb-0">TOTAL A PAGAR:</h5>
          </div>
          <div class="col-md-6 text-end">
            <h4 class="mb-0" id="total-pagar-usd">USD. 0.00</h4>
            <h5 class="mb-0" id="total-pagar">BS. 0.00</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Datos de la venta -->
    <div class="form-container">
      <h3 class="text-center mb-3">DATOS DE LA VENTA</h3>
      <form id="form-finalizar-venta">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Fecha</label>
            <input type="date" class="form-control" id="fecha" required>
          </div>
          <!-- El campo de tasa de cambio fue movido arriba -->
          <div class="col-md-6" style="display: none;">
            <!-- Este campo se mantiene oculto para no romper la estructura pero ya no se usado -->
            <input type="number" step="0.01" min="1" class="form-control" id="tasa-cambio-old" value="140">
          </div>
        </div>
        
        <!-- MÃ©todos de pago -->
        <div class="mt-4" id="metodos-pago-container">
          <h5 class="mb-3">MÃTODOS DE PAGO</h5>
          <div id="metodos-pago">
            <!-- Los mÃ©todos de pago se agregarÃ¡n aquÃ­ dinÃ¡micamente -->
          </div>
          
          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-outline-primary" id="btn-agregar-metodo">
              <i class="bi bi-plus-circle"></i> Agregar MÃ©todo de Pago
            </button>
            <div>
              <span id="restante-pagar" class="restante-pendiente">Restante por pagar: USD 0.00 (BS 0.00)</span>
            </div>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-principal" id="btn-finalizar" disabled>
            FINALIZAR VENTA
          </button><br>
          <a class="enlace" href="index.html">
            <button type="button" class="btn btn-principal mt-2">
              â Volver al MenÃº
            </button>
          </a>
        </div>
      </form>
    </div>

    <!-- Loading indicator -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
      <div style="text-align: center; color: white;">
        <svg style="animation: spin 1s linear infinite; width: 40px; height: 40px; margin-bottom: 10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>Procesando venta...</p>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
   // ConfiguraciÃ³n de Supabase
    const SUPABASE_URL = 'https://rirfvhvlmytnpqkcpxbx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcmZ2aHZsbXl0bnBxa2NweGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODE2NDUsImV4cCI6MjA3MjA1NzY0NX0.5JLGuOIWNvKIESJG26JLOgRVCu0jVoH0ELZjQ63gV48';
    
    // Inicializar Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let todosLosProductos = [];
    let carrito = [];
    let productoSeleccionado = null;
    let precioSeleccionado = null;
    let monedaPrecioSeleccionado = ''; // 'USD' o 'BS'
    let metodosPago = [];

    // FunciÃ³n para redondear a 2 decimales de manera consistente
    function redondearADosDecimales(valor) {
      return Math.round(valor * 100) / 100;
    }

    // FunciÃ³n para comparar valores monetarios con tolerancia
    function sonIgualesMonetariamente(valor1, valor2) {
      return Math.abs(valor1 - valor2) < 0.01;
    }

    // Obtener fecha actual en formato YYYY-MM-DD sin problemas de zona horaria
    function obtenerFechaActual() {
      const ahora = new Date();
      const offset = ahora.getTimezoneOffset();
      const fechaLocal = new Date(ahora.getTime() - (offset * 60 * 1000));
      return fechaLocal.toISOString().split('T')[0];
    }

    function formatearFechaLocal(fechaString) {
      const [year, month, day] = fechaString.split('-');
      const fecha = new Date(year, month - 1, day);
      
      return fecha.toLocaleDateString('es-VE', {
        year: 'numeric',
        month: 'numeric',  
        day: 'numeric'
      });
    }

    // Obtener la tasa de cambio actual del input
    function obtenerTasaCambio() {
      const tasaInput = parseFloat($('#tasa-cambio').val());
      return isNaN(tasaInput) || tasaInput <= 0 ? 140 : tasaInput;
    }

    // Convertir precio de BS a USD usando la tasa del input
    function convertirBsAUsd(precioBs) {
      const tasaActual = obtenerTasaCambio();
      return redondearADosDecimales(precioBs / tasaActual);
    }

    // Convertir precio de USD a BS usando la tasa del input
    function convertirUsdABs(precioUsd) {
      const tasaActual = obtenerTasaCambio();
      return redondearADosDecimales(precioUsd * tasaActual);
    }

    // Cargar productos desde Supabase
    async function cargarProductos() {
      try {
        console.log('Cargando productos desde Supabase...');
        const { data: productos, error } = await supabaseClient
          .from('productos')
          .select('*')
          .gt('cantidad', 0)
          .order('nombre', { ascending: true });

        if (error) {
          console.error('Error de Supabase:', error);
          throw error;
        }
        
        todosLosProductos = productos || [];
        console.log('Productos cargados:', todosLosProductos);
        inicializarSelect2();
        
      } catch (error) {
        console.error('Error al cargar productos:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al cargar productos: ' + error.message
        });
      }
    }

    // Inicializar Select2 con productos de Supabase
    function inicializarSelect2() {
      console.log('Inicializando Select2 con', todosLosProductos.length, 'productos');
      
      // Limpiar opciones existentes
      $('#producto').empty().append('<option value="">Buscar producto...</option>');
      
      // Agregar productos como opciones
      todosLosProductos.forEach(producto => {
        $('#producto').append(new Option(
          `${producto.nombre} - ${producto.marca || 'Sin marca'}`,
          producto.id,
          false,
          false
        ));
      });
      
      // Inicializar Select2
      $('.js-product-search').select2({
        placeholder: "Buscar producto...",
        width: '100%',
        language: "es"
      });
      
      console.log('Select2 inicializado correctamente');
    }

    // Manejar selecciÃ³n de producto
    function manejarSeleccionProducto() {
      $('#producto').on('change', function() {
        const productoId = $(this).val();
        
        console.log('Producto seleccionado ID:', productoId);
        
        if (productoId) {
          // Obtener el producto seleccionado
          productoSeleccionado = todosLosProductos.find(p => p.id === productoId);
          
          if (productoSeleccionado) {
            console.log('Producto encontrado:', productoSeleccionado);
            
            // Habilitar tipo de venta
            $('#tipo-venta').prop('disabled', false);
            
            // Limpiar campos dependientes
            $('#tipo-venta').val('');
            $('#precio-selector').empty().append('<option value="">Seleccione precio</option>').prop('disabled', true);
            $('#unidad').val('');
            $('#cantidad').val('1').prop('disabled', true);
            $('#btn-agregar').prop('disabled', true);
            ocultarInfoMayor();
          } else {
            console.error('Producto no encontrado en la lista');
          }
        } else {
          productoSeleccionado = null;
          precioSeleccionado = null;
          monedaPrecioSeleccionado = '';
          limpiarCamposDependientes();
        }
      });
    }

    // Llenar selector de precios segÃºn el tipo de venta
    function llenarSelectorPrecios(tipoVenta) {
      if (!productoSeleccionado) return;
      
      $('#precio-selector').empty().append('<option value="">Seleccione precio</option>');
      
      const cantidadPorEmpaque = productoSeleccionado.cantidad_por_empaque || 1;
      
      if (tipoVenta === 'detal') {
        // Para venta al detal, todos los precios se dividen entre cantidad_por_empaque
        // Precio 1: USD (precio_venta_1_usd / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_1_usd && productoSeleccionado.precio_venta_1_usd > 0) {
          const precioDetalUSD = redondearADosDecimales(productoSeleccionado.precio_venta_1_usd / cantidadPorEmpaque);
          $('#precio-selector').append(new Option(
            `Precio 1: USD ${precioDetalUSD.toFixed(2)}`,
            JSON.stringify({precio: precioDetalUSD, moneda: 'USD'}),
            false,
            false
          ));
        }
        
        // Precio 2: BS (precio_venta_2 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_2 && productoSeleccionado.precio_venta_2 > 0) {
          const precioDetalBS2 = redondearADosDecimales(productoSeleccionado.precio_venta_2 / cantidadPorEmpaque);
          $('#precio-selector').append(new Option(
            `Precio 2: BS ${precioDetalBS2.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS2, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 3: BS (precio_venta_3 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_3 && productoSeleccionado.precio_venta_3 > 0) {
          const precioDetalBS3 = redondearADosDecimales(productoSeleccionado.precio_venta_3 / cantidadPorEmpaque);
          $('#precio-selector').append(new Option(
            `Precio 3: BS ${precioDetalBS3.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS3, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 4: BS (precio_venta_4 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_4 && productoSeleccionado.precio_venta_4 > 0) {
          const precioDetalBS4 = redondearADosDecimales(productoSeleccionado.precio_venta_4 / cantidadPorEmpaque);
          $('#precio-selector').append(new Option(
            `Precio 4: BS ${precioDetalBS4.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS4, moneda: 'BS'}),
            false,
            false
          ));
        }
      } else if (tipoVenta === 'mayor') {
        // Para venta al mayor, se muestran los precios directamente sin dividir
        // Precio 1: USD (precio_venta_1_usd)
        if (productoSeleccionado.precio_venta_1_usd && productoSeleccionado.precio_venta_1_usd > 0) {
          $('#precio-selector').append(new Option(
            `Precio 1: USD ${productoSeleccionado.precio_venta_1_usd.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_1_usd, moneda: 'USD'}),
            false,
            false
          ));
        }
        
        // Precio 2: BS (precio_venta_2)
        if (productoSeleccionado.precio_venta_2 && productoSeleccionado.precio_venta_2 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 2: BS ${productoSeleccionado.precio_venta_2.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_2, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 3: BS (precio_venta_3)
        if (productoSeleccionado.precio_venta_3 && productoSeleccionado.precio_venta_3 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 3: BS ${productoSeleccionado.precio_venta_3.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_3, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 4: BS (precio_venta_4)
        if (productoSeleccionado.precio_venta_4 && productoSeleccionado.precio_venta_4 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 4: BS ${productoSeleccionado.precio_venta_4.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_4, moneda: 'BS'}),
            false,
            false
          ));
        }
      }
      
      // Habilitar selector de precios
      $('#precio-selector').prop('disabled', false);
    }

    // Manejar selecciÃ³n de precio
    function manejarSeleccionPrecio() {
      $('#precio-selector').on('change', function() {
        const precioData = $(this).val();
        
        if (precioData) {
          const data = JSON.parse(precioData);
          precioSeleccionado = data.precio;
          monedaPrecioSeleccionado = data.moneda;
          
          // Si ya estÃ¡ seleccionado el tipo de venta, actualizar cÃ¡lculos
          const tipoVenta = $('#tipo-venta').val();
          if (tipoVenta) {
            actualizarCalculosVenta();
            $('#btn-agregar').prop('disabled', false);
          }
        } else {
          precioSeleccionado = null;
          monedaPrecioSeleccionado = '';
          $('#btn-agregar').prop('disabled', true);
        }
      });
    }

    // Manejar selecciÃ³n de tipo de venta
    function manejarTipoVenta() {
      $('#tipo-venta').on('change', function() {
        const tipoVenta = $(this).val();
        
        if (tipoVenta && productoSeleccionado) {
          // Llenar selector de precios segÃºn el tipo de venta
          llenarSelectorPrecios(tipoVenta);
          
          // Habilitar cantidad inmediatamente al seleccionar tipo de venta
          $('#cantidad').prop('disabled', false);
          
          // Establecer la unidad segÃºn el tipo de venta
          if (tipoVenta === 'detal') {
            $('#unidad').val('Unidad');
            ocultarInfoMayor();
          } else if (tipoVenta === 'mayor') {
            // Verificar que el producto tenga empaque mayor configurado
            if (productoSeleccionado.empaque_mayor && productoSeleccionado.cantidad_por_empaque > 0) {
              $('#unidad').val(productoSeleccionado.empaque_mayor);
              mostrarInfoMayor();
            } else {
              Swal.fire({
                icon: 'warning',
                title: 'Producto sin empaque mayor',
                text: 'Este producto no tiene configurado empaque para venta al mayor'
              });
              $(this).val('');
              $('#unidad').val('');
              $('#cantidad').prop('disabled', true);
              $('#btn-agregar').prop('disabled', true);
              return;
            }
          }
          
          // Si ya hay precio seleccionado, habilitar botÃ³n de agregar
          if (precioSeleccionado) {
            $('#btn-agregar').prop('disabled', false);
            actualizarCalculosVenta();
          }
        } else {
          $('#unidad').val('');
          $('#cantidad').prop('disabled', true);
          $('#btn-agregar').prop('disabled', true);
          ocultarInfoMayor();
        }
      });
    }

    // Mostrar informaciÃ³n para venta al mayor
    function mostrarInfoMayor() {
      const infoMayor = document.getElementById('info-mayor');
      const infoEmpaque = document.getElementById('info-empaque');
      
      infoMayor.style.display = 'block';
      infoEmpaque.textContent = `Cada ${productoSeleccionado.empaque_mayor.toLowerCase()} contiene ${productoSeleccionado.cantidad_por_empaque} unidades`;
    }

    // Ocultar informaciÃ³n para venta al mayor
    function ocultarInfoMayor() {
      document.getElementById('info-mayor').style.display = 'none';
    }

    // Actualizar cÃ¡lculos para la venta
    function actualizarCalculosVenta() {
      const cantidad = parseInt($('#cantidad').val()) || 0;
      const tipoVenta = $('#tipo-venta').val();
      
      if (productoSeleccionado && precioSeleccionado && cantidad > 0) {
        // Calcular subtotal
        let subtotal = redondearADosDecimales(precioSeleccionado * cantidad);
        let subtotalUSD = 0;
        let subtotalBS = 0;
        
        if (monedaPrecioSeleccionado === 'USD') {
          subtotalUSD = subtotal;
          subtotalBS = convertirUsdABs(subtotal);
        } else {
          subtotalBS = subtotal;
          subtotalUSD = convertirBsAUsd(subtotal);
        }
        
        // Actualizar vista previa de subtotal
        $('#subtotal-preview').text(`Subtotal: USD ${subtotalUSD.toFixed(2)} (BS ${subtotalBS.toFixed(2)})`);
        
        // Si es venta al mayor, mostrar total de unidades
        if (tipoVenta === 'mayor') {
          const totalUnidades = productoSeleccionado.cantidad_por_empaque * cantidad;
          $('#total-unidades').text(`Total: ${totalUnidades} unidades`);
        }
      }
    }

    // Limpiar campos dependientes
    function limpiarCamposDependientes() {
      $('#tipo-venta').val('').prop('disabled', true);
      $('#precio-selector').empty().append('<option value="">Seleccione precio</option>').prop('disabled', true);
      $('#unidad').val('');
      $('#cantidad').val('1').prop('disabled', true);
      $('#btn-agregar').prop('disabled', true);
      ocultarInfoMayor();
    }

    // Manejar cambios en la cantidad
    function manejarCambioCantidad() {
      $('#cantidad').on('input', function() {
        actualizarCalculosVenta();
      });
    }


 // Agregar producto al carrito (normalizado a USD siempre)
function agregarAlCarrito() {
  $('#form-agregar-producto').on('submit', function(e) {
    e.preventDefault();

    const productoId = $('#producto').val();
    const tipoVenta = $('#tipo-venta').val();
    const cantidad = parseInt($('#cantidad').val()) || 0;
    const tasa = obtenerTasaCambio();

    if (!productoId || !tipoVenta || !precioSeleccionado || cantidad <= 0) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Complete todos los campos correctamente' });
      return;
    }

    // Verificar stock disponible
    if (cantidad > productoSeleccionado.cantidad) {
      Swal.fire({
        icon: 'error',
        title: 'Stock insuficiente',
        text: `Solo hay ${productoSeleccionado.cantidad} unidades disponibles`
      });
      return;
    }

    // Calcular unidades totales
    let unidades = cantidad;
    if (tipoVenta === 'mayor') {
      unidades = productoSeleccionado.cantidad_por_empaque * cantidad;
    }

    // Normalizar precios
    let precioUnitarioUSD = 0;
    let precioUnitarioBS = 0;
    if (monedaPrecioSeleccionado === 'USD') {
      precioUnitarioUSD = precioSeleccionado;
      precioUnitarioBS = precioSeleccionado * tasa;
    } else {
      precioUnitarioBS = precioSeleccionado;
      precioUnitarioUSD = precioSeleccionado / tasa;
    }

    // Subtotales (en USD base)
    const subtotalUSD = precioUnitarioUSD * cantidad;
    const subtotalBS = subtotalUSD * tasa;

    // Agregar al carrito
    const itemCarrito = {
      producto_id: productoSeleccionado.id,
      nombre: productoSeleccionado.nombre,
      marca: productoSeleccionado.marca || '',
      tipo_venta: tipoVenta,
      cantidad,
      unidades,
      precio_unitario_usd: precioUnitarioUSD,
      precio_unitario_bs: precioUnitarioBS,
      subtotal_usd: subtotalUSD,
      subtotal_bs: subtotalBS,
      moneda_precio: 'USD', // Siempre normalizado
      empaque_mayor: tipoVenta === 'mayor' ? productoSeleccionado.empaque_mayor : 'Unidad',
      unidades_por_empaque: tipoVenta === 'mayor' ? productoSeleccionado.cantidad_por_empaque : 1
    };

    carrito.push(itemCarrito);
    console.log('Producto agregado al carrito (normalizado):', itemCarrito);

    actualizarCarrito();

    // Reset formulario
    $('#producto').val('').trigger('change');
    productoSeleccionado = null;
    precioSeleccionado = null;
    monedaPrecioSeleccionado = '';
    limpiarCamposDependientes();

    Swal.fire({
      icon: 'success',
      title: 'Producto agregado',
      text: 'El producto se ha agregado al carrito correctamente',
      timer: 1500,
      showConfirmButton: false
    });
  });
}

// Actualizar vista del carrito
function actualizarCarrito() {
  const carritoBody = $('#carrito-body');
  carritoBody.empty();

  if (carrito.length === 0) {
    carritoBody.append('<tr><td colspan="7" class="text-center text-muted">No hay productos en el carrito</td></tr>');
  } else {
    carrito.forEach((item, index) => {
      let detalleUnidades = '';
      if (item.tipo_venta === 'mayor') {
        detalleUnidades = `<span class="detalle-unidades">${item.cantidad} ${item.empaque_mayor} Ã ${item.unidades_por_empaque} unidades = ${item.unidades} unidades</span>`;
      }

      const fila = `
        <tr>
          <td>${item.nombre}<br><small class="text-muted">${item.marca}</small>${detalleUnidades}</td>
          <td>${item.tipo_venta === 'mayor' ? 'Al Mayor' : 'Al Detal'}</td>
          <td>${item.cantidad}</td>
          <td>${item.unidades}</td>
          <td>USD ${item.precio_unitario_usd.toFixed(2)}<br><small class="detalle-unidades">BS ${item.precio_unitario_bs.toFixed(2)}</small></td>
          <td>USD ${item.subtotal_usd.toFixed(2)}<br><small class="detalle-unidades">BS ${item.subtotal_bs.toFixed(2)}</small></td>
          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
      carritoBody.append(fila);
    });
  }

  actualizarTotales();
}

    // Eliminar producto del carrito
    function eliminarDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    }

    // Actualizar totales del carrito
    function actualizarTotales() {
      let totalUSD = 0;
      let totalBS = 0;
      
      carrito.forEach(item => {
        totalUSD = redondearADosDecimales(totalUSD + item.subtotal_usd);
        totalBS = redondearADosDecimales(totalBS + item.subtotal_bs);
      });
      
      $('#total-pagar-usd').text(`USD. ${totalUSD.toFixed(2)}`);
      $('#total-pagar').text(`BS. ${totalBS.toFixed(2)}`);
      
      // Actualizar restante por pagar en mÃ©todos de pago
      actualizarRestantePagar();
      
      // Habilitar o deshabilitar botÃ³n de finalizar
      const btnFinalizar = $('#btn-finalizar');
      btnFinalizar.prop('disabled', carrito.length === 0);
    }

    // Agregar mÃ©todo de pago
    function agregarMetodoPago() {
      $('#btn-agregar-metodo').on('click', function() {
        const metodoHTML = `
          <div class="metodo-pago">
            <div class="metodo-pago-header">
              <div>
                <label class="form-label">MÃ©todo de Pago</label>
                <select class="form-select metodo-pago-tipo" required>
                  <option value="">Seleccione mÃ©todo</option>
                  <option value="Efectivo">Efectivo BS</option>
                  <option value="DÃ³lares">Efectivo USD</option>
                  <option value="Transferencia">Transferencia</option>
                  <option value="Pago mÃ³vil">Pago MÃ³vil</option>
                  <option value="Punto de venta">Punto de Venta</option>
				  <option value="Biopago">Biopago</option>
                </select>
              </div>
              <div>
                <label class="form-label">Monto</label>
                <input type="number" step="0.01" min="0.01" class="form-control metodo-pago-monto" required>
              </div>
              <div>
                <label class="form-label">Moneda</label>
                <select class="form-select metodo-pago-moneda" required>
                  <option value="BS">BS</option>
                  <option value="USD">USD</option>
                </select>
              </div>
              <div>
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger btn-eliminar-metodo">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        $('#metodos-pago').append(metodoHTML);
        
        // Asignar evento al botÃ³n de eliminar
        $('.btn-eliminar-metodo').off('click').on('click', function() {
          $(this).closest('.metodo-pago').remove();
          actualizarRestantePagar();
        });
        
        // Asignar eventos a los campos del mÃ©todo de pago
        $('.metodo-pago-tipo, .metodo-pago-monto, .metodo-pago-moneda').off('change input').on('change input', function() {
          actualizarRestantePagar();
        });
      });
    }

function actualizarRestantePagar() {
  const totalPagarUSD = parseFloat($('#total-pagar-usd').text().replace('USD. ', '')) || 0;
  const totalPagarBS  = parseFloat($('#total-pagar').text().replace('BS. ', '')) || 0;

  let totalPagadoUSD = 0;
  let totalPagadoBS  = 0;
  const tasa = obtenerTasaCambio();

  $('.metodo-pago').each(function () {
    const monto = parseFloat($(this).find('.metodo-pago-monto').val()) || 0;
    const moneda = $(this).find('.metodo-pago-moneda').val();

    if (moneda === 'BS') {
      totalPagadoBS  += monto;
      totalPagadoUSD += monto / tasa;
    } else {
      totalPagadoUSD += monto;
      totalPagadoBS  += monto * tasa;
    }
  });

  let restanteUSD = totalPagarUSD - totalPagadoUSD;
  let restanteBS  = totalPagarBS - totalPagadoBS;

  // Limpieza flotantes
  if (Math.abs(restanteUSD) < 0.01) restanteUSD = 0;
  if (Math.abs(restanteBS) < 0.01) restanteBS = 0;

  const restanteElement = $('#restante-pagar');

  if (restanteUSD === 0 && restanteBS === 0) {
    // â Pago completado
    restanteElement.removeClass('restante-pendiente').addClass('pago-completado');
    restanteElement.html(`<i class="bi bi-check-circle-fill"></i> Pago completado`);
  } else if (restanteUSD < 0 || restanteBS < 0) {
    // Cambio
    restanteElement.removeClass('pago-completado').addClass('restante-pendiente');
    restanteElement.text(
      `Cambio a devolver: USD ${Math.abs(restanteUSD).toFixed(2)} (BS ${Math.abs(restanteBS).toFixed(2)})`
    );
  } else {
    // AÃºn falta pagar
    restanteElement.removeClass('pago-completado').addClass('restante-pendiente');
    restanteElement.text(
      `Restante por pagar: USD ${restanteUSD.toFixed(2)} (BS ${restanteBS.toFixed(2)})`
    );
  }
}

function finalizarVenta() {
  $('#form-finalizar-venta').off('submit').on('submit', async function (e) {
    e.preventDefault();

    const TOLERANCIA = 0.01;

    function cleanCantidad(n) {
      if (!isFinite(n)) return 0;
      if (Math.abs(n) < TOLERANCIA) return 0;
      return n;
    }

    function formatBsDisplay(x) {
      if (x === null || x === undefined || isNaN(x)) return '0.00';
      return Number(x).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatUsdDisplay(x) {
      if (x === null || x === undefined || isNaN(x)) return '0.00';
      return Number(x).toFixed(2);
    }

    // --- 1) Validar carrito ---
    if (!Array.isArray(carrito) || carrito.length === 0) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'No hay productos en el carrito' });
      return;
    }

    // --- 2) Validar fecha ---
    const fechaVenta = $('#fecha').val();
    if (!fechaVenta) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Seleccione una fecha para la venta' });
      return;
    }

    // --- 3) Recolectar mÃ©todos de pago ---
    const metodosPagoActuales = [];
    let hayMetodosInvalidos = false;

    $('.metodo-pago').each(function () {
      const tipo   = $(this).find('.metodo-pago-tipo').val();
      const monto  = parseFloat($(this).find('.metodo-pago-monto').val()) || 0;
      const moneda = $(this).find('.metodo-pago-moneda').val();

      if (!tipo || monto <= 0) {
        hayMetodosInvalidos = true;
        return false;
      }

      metodosPagoActuales.push({ tipo, monto, moneda });
    });

    if (hayMetodosInvalidos || metodosPagoActuales.length === 0) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Complete correctamente los mÃ©todos de pago' });
      return;
    }

    // --- 4) Totales desde carrito ---
    let totalPagarUSD = 0;
    let totalPagarBS  = 0;

    for (const it of carrito) {
      totalPagarUSD += Number(it.subtotal_usd || 0);
      totalPagarBS  += Number(it.subtotal_bs || 0);
    }

    $('#total-pagar-usd').text(`USD. ${formatUsdDisplay(totalPagarUSD)}`);
    $('#total-pagar').text(`BS. ${formatBsDisplay(totalPagarBS)}`);

    // --- 5) Calcular pagos ---
    const tasa = obtenerTasaCambio();
    let totalPagadoUSD = 0;
    let totalPagadoBS  = 0;

    const pagosProcesados = metodosPagoActuales.map(m => {
      const monto = Number(m.monto || 0);
      let monto_usd = 0;
      let monto_bs  = 0;

      if (m.moneda === 'BS') {
        monto_bs = monto;
        monto_usd = monto / tasa;
      } else {
        monto_usd = monto;
        monto_bs  = monto * tasa;
      }

      totalPagadoUSD += monto_usd;
      totalPagadoBS  += monto_bs;

      return {
        tipo: m.tipo,
        moneda_original: m.moneda,
        monto_original: monto,
        monto_usd,
        monto_bs
      };
    });

    // --- 6) Restante ---
    let restanteUSD = cleanCantidad(totalPagarUSD - totalPagadoUSD);
    let restanteBS  = cleanCantidad(totalPagarBS - totalPagadoBS);

    const restanteElement = $('#restante-pagar');
    if (restanteUSD === 0 && restanteBS === 0) {
      restanteElement.removeClass('restante-pendiente').addClass('pago-completado');
      restanteElement.html(`<i class="bi bi-check-circle-fill"></i> Pago completado`);
    } else if (restanteUSD < 0 || restanteBS < 0) {
      restanteElement.removeClass('pago-completado').addClass('restante-pendiente');
      restanteElement.text(
        `Cambio a devolver: USD ${Math.abs(restanteUSD).toFixed(2)} (BS ${formatBsDisplay(Math.abs(restanteBS))})`
      );
    } else {
      restanteElement.removeClass('pago-completado').addClass('restante-pendiente');
      restanteElement.text(
        `Restante por pagar: USD ${formatUsdDisplay(restanteUSD)} (BS ${formatBsDisplay(restanteBS)})`
      );
    }

    if (restanteUSD > TOLERANCIA || restanteBS > TOLERANCIA) {
      Swal.fire({ icon: 'error', title: 'Pago insuficiente', text: 'El monto pagado no cubre el total de la venta' });
      return;
    }

    // --- 7) ConfirmaciÃ³n ---
    const productosTexto = carrito.map(item => {
      const marca = item.marca ? ` (${item.marca})` : '';
      const precioUnitario = Number(item.precio_unitario || 0); // ð evitar NaN
      let detalle = `â¢ ${item.nombre}${marca}<br>&nbsp;&nbsp;${item.tipo_venta === 'mayor' ? 'Al Mayor' : 'Al Detal'} - ${item.cantidad}`;
      if (item.tipo_venta === 'mayor') {
        detalle += ` Ã ${item.unidades_por_empaque} unidades = ${item.unidades} unidades`;
      }
      detalle += ` Ã ${item.moneda_precio} ${precioUnitario.toFixed(2)} = USD ${formatUsdDisplay(item.subtotal_usd)} (BS ${formatBsDisplay(item.subtotal_bs)})`;
      return detalle;
    }).join('<br>');

    const metodosPagoTexto = pagosProcesados.map(p => {
      const original = `${p.moneda_original} ${Number(p.monto_original).toFixed(2)}`;
      return `â¢ ${p.tipo}: ${original} â USD ${formatUsdDisplay(p.monto_usd)} / BS ${formatBsDisplay(p.monto_bs)}`;
    }).join('<br>');

    const confirmacion = await Swal.fire({
      title: 'Â¿Confirmar venta?',
      html: `
        <div style="text-align:left; font-size:0.95em;">
          <p><strong>ð Fecha:</strong> ${formatearFechaLocal(fechaVenta)}</p>
          <p><strong>ð Productos (${carrito.length} items):</strong></p>
          <div style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; border-radius:5px; background:#f8f9fa;">
            ${productosTexto}
          </div>
          <p style="margin-top:10px;"><strong>ð³ MÃ©todos de pago:</strong></p>
          <div style="border:1px solid #ddd; padding:10px; border-radius:5px; background:#f8f9fa;">
            ${metodosPagoTexto}
          </div>
          <div style="margin-top:15px; padding:10px; background:#e8f5e8; border-radius:5px; border:1px solid #c3e6c3;">
            <strong>ð° Total a pagar:</strong><br>
            USD ${formatUsdDisplay(totalPagarUSD)} (BS ${formatBsDisplay(totalPagarBS)})
          </div>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'SÃ­, confirmar venta',
      cancelButtonText: 'Cancelar',
      confirmButtonColor: '#3105f1',
      cancelButtonColor: '#6c757d',
      width: '640px'
    });

    if (!confirmacion.isConfirmed) return;

    // --- 8) Guardar en BD ---
    $('#loadingOverlay').show();
    try {
      const tiposPagoUnicos = [...new Set(metodosPagoActuales.map(p => p.tipo))];
      const tipoPagoString  = tiposPagoUnicos.join(', ');

      // Insertar venta
      const { data: ventaInsertada, error: errorVenta } = await supabaseClient
        .from('ventas')
        .insert([{
          fecha: fechaVenta,
          tasa_cambio: tasa,
          total_usd: totalPagarUSD,
          total: totalPagarBS,
          tipo_pago: tipoPagoString
        }])
        .select()
        .single();

      if (errorVenta) throw errorVenta;
      const ventaId = ventaInsertada.id;

      // Insertar detalles
      const detalles = carrito.map(item => ({
        venta_id: ventaId,
        producto_id: item.producto_id,
        tipo_venta: item.tipo_venta,
        cantidad: item.unidades,
        unidades: item.unidades,
        precio_unitario: Number(item.precio_unitario || 0),
        moneda_precio: item.moneda_precio,
        subtotal_usd: item.subtotal_usd,
        subtotal_bs: item.subtotal_bs
      }));

      const { error: errorDetalles } = await supabaseClient.from('detalles_venta').insert(detalles);
      if (errorDetalles) throw errorDetalles;

      // Actualizar stock
      for (const item of carrito) {
        const producto = todosLosProductos.find(p => p.id === item.producto_id);
        if (producto) {
          const nuevaCantidad = Number(producto.cantidad) - Number(item.unidades || 0);
          const { error: errorStock } = await supabaseClient
            .from('productos')
            .update({ cantidad: nuevaCantidad })
            .eq('id', item.producto_id);
          if (errorStock) throw errorStock;
        }
      }

      // Insertar pagos
      for (const p of pagosProcesados) {
        const { error: errorPago } = await supabaseClient.from('pagos_venta').insert([{
          venta_id: ventaId,
          metodo: p.tipo,
          monto_bs: p.monto_bs,
          monto_usd: p.monto_usd
        }]);
        if (errorPago) throw errorPago;
      }

      $('#loadingOverlay').hide();

      await Swal.fire({
        icon: 'success',
        title: 'Venta registrada',
        html: `
          <div style="text-align:left;">
            <p>La venta se ha registrado correctamente</p>
            <p><strong>Fecha:</strong> ${formatearFechaLocal(fechaVenta)}</p>
            <p><strong>Total:</strong> USD ${formatUsdDisplay(totalPagarUSD)} (BS ${formatBsDisplay(totalPagarBS)})</p>
          </div>
        `,
        confirmButtonColor: '#3105f1'
      });

      // Reset
      carrito.length = 0;
      actualizarCarrito();
      $('#metodos-pago').empty();
      $('#form-finalizar-venta')[0].reset();
      $('#fecha').val(obtenerFechaActual());
      $('#restante-pagar').text('Restante por pagar: USD 0.00 (BS 0)')
        .removeClass('pago-completado').addClass('restante-pendiente');
      await cargarProductos();

    } catch (error) {
      $('#loadingOverlay').hide();
      console.error('Error al finalizar venta:', error);
      Swal.fire({ icon: 'error', title: 'Error', text: 'Error al registrar la venta: ' + (error.message || error) });
    }
  });
}


//fin de finalizar venta

async function cargarUltimaTasaCambio() {
  try {
    const { data, error } = await supabaseClient
      .from('ventas')
      .select('tasa_cambio')
      .order('fecha', { ascending: false })
      .limit(1);

    if (error) throw error;

    if (data && data.length > 0 && data[0].tasa_cambio) {
      console.log('Ãltima tasa encontrada:', data[0].tasa_cambio);
      $('#tasa-cambio').val(data[0].tasa_cambio); // colocar tasa en el input
    } else {
      console.warn('No se encontraron ventas, usando valor por defecto.');
      // Puedes dejar el input como estÃ¡ o setear un valor fijo
      $('#tasa-cambio').val(140);  
    }
  } catch (err) {
    console.error('Error al cargar la Ãºltima tasa de cambio:', err.message);
    // en caso de error, no se modifica el valor por defecto
  }
}


    // Inicializar la aplicaciÃ³n
    $(document).ready(function() {
      console.log('Inicializando aplicaciÃ³n...');
       cargarUltimaTasaCambio();
      // Establecer fecha actual
      $('#fecha').val(obtenerFechaActual());
      
      
      // Cargar productos
      cargarProductos().then(() => {
        // Configurar eventos despuÃ©s de cargar productos
        manejarSeleccionProducto();
        manejarTipoVenta();
        manejarSeleccionPrecio();
        manejarCambioCantidad();
        agregarAlCarrito();
        agregarMetodoPago();
        finalizarVenta();
        
        console.log('AplicaciÃ³n inicializada correctamente');
      }).catch(error => {
        console.error('Error al inicializar aplicaciÃ³n:', error);
      });
    });

    // Hacer funciones disponibles globalmente
    window.eliminarDelCarrito = eliminarDelCarrito;
  </script>
</body>
</html>