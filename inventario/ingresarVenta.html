<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        #info-mayor {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #3105f1;
            color: white;
        }

        #info-mayor small {
            color: #ffffff !important;
        }

        #info-mayor .text-muted {
            color: #ffffff !important;
        }

        #cantidad {
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            color: #ffffff !important;
        }

        #cantidad:focus {
            background-color: #2a2a2a !important;
            border-color: #041fbd !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25) !important;
        }

        #cantidad:disabled {
            background-color: #333333 !important;
            color: #888888 !important;
            border-color: #555555 !important;
        }

        input[type="number"] {
            width: 70px;
            text-align: center;
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            color: #ffffff !important;
        }

        input[type="number"]:focus {
            background-color: #2a2a2a !important;
            border-color: #041fbd !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25) !important;
        }

        input[type="number"]:disabled {
            background-color: #333333 !important;
            color: #888888 !important;
            border-color: #555555 !important;
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .logo-container {
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .enlace {
            text-align: center;
            display: block;
            text-decoration: none;
        }

        .enlace:hover {
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .form-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-control, .form-select {
            background-color: #2a2a2a;
            border: 1px solid #3105f1;
            color: white;
        }

        .form-control:focus, .form-select:focus {
            background-color: #2a2a2a;
            border-color: #041fbd;
            box-shadow: 0 0 0 0.25rem rgba(5, 100, 45, 0.25);
        }

        .btn-principal {
            background-color: #3105f1;
            color: #fff;
            padding: 12px 40px;
            border: none;
            font-size: 1.1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .btn-principal:hover {
            background-color: #041fbd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-principal:active {
            transform: translateY(0);
        }

        .btn-danger {
            background-color: #dc3545;
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-danger:active {
            transform: translateY(0);
        }

        .table-carrito {
            color: white;
            width: 100%;
        }

        .table-carrito thead th {
            background-color: #3105f1;
            border-color: #041fbd;
            padding: 10px 8px;
        }

        .table-carrito tbody td {
            padding: 8px;
            vertical-align: middle;
        }

        .table-carrito tbody tr {
            background-color: #2a2a2a;
        }

        .table-carrito tbody tr:nth-child(even) {
            background-color: #333333;
        }

        .total-container {
            background-color: #3105f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .select2-container--default .select2-selection--single {
            background-color: #2a2a2a !important;
            border: 1px solid #3105f1 !important;
            height: 38px;
            color: white !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: white !important;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: white transparent transparent transparent !important;
        }
        
        .select2-container--default .select2-results__option {
            background-color: #3105f1 !important;
            color: white !important;
            padding: 8px 12px !important;
        }
        
        .select2-container--default .select2-results__option--highlighted {
            background-color: #0648d6 !important;
        }
        
        .select2-dropdown {
            background-color: #3105f1 !important;
            border: 1px solid #034d21 !important;
        }

        .form-control:disabled, .form-select:disabled {
            background-color: #333333;
            cursor: not-allowed;
            border-color: #555555;
        }

        .metodo-pago {
            background-color: #2a2a2a;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #3105f1;
        }
        
        .metodo-pago-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-pago {
            font-weight: bold;
            color: #ffffff;
            text-align: right;
        }
        
        .restante-pendiente {
            font-size: 0.9rem;
            color: #ffcc00;
        }
        
        .pago-completado {
            color: #00cc66;
        }

        .detalle-unidades {
            font-size: 0.85rem;
            color: #cccccc;
            display: block;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            .table-carrito thead th, 
            .table-carrito tbody td {
                padding: 6px 4px;
                font-size: 0.9rem;
            }
            
            .btn-principal {
                padding: 10px 30px;
                font-size: 1rem;
            }
            
            .btn-danger {
                padding: 5px 10px;
                font-size: 0.9rem;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-12 text-center logo-container">
          <img alt="Logo" src="logo.png" class="img-fluid" height="150px" width="350px">
        </div>
    </div>

    <!-- Formulario para agregar productos -->
    <div class="form-container">
      <h3 class="text-center mb-3">INGRESAR VENTA</h3>
      <form id="form-agregar-producto">
        <div class="row g-2">
          <!-- Tasa de Cambio (movido aquÃ­ desde abajo) -->
          <div class="col-md-3">
            <label class="form-label">Tasa de Cambio (BS a USD)</label>
            <input type="number" step="1" min="1" class="form-control" id="tasa-cambio" value="140" required>
          </div>
          
          <!-- Producto -->
          <div class="col-md-3">
            <label class="form-label">Producto</label>
            <select class="form-control js-product-search" id="producto" required>
              <option value="">Buscar producto...</option>
            </select>
          </div>
          
          <!-- Tipo de Venta -->
          <div class="col-md-2">
            <label class="form-label">Tipo de Venta</label>
            <select class="form-select" id="tipo-venta" required disabled>
              <option value="">Seleccione</option>
              <option value="detal">Al Detal</option>
              <option value="mayor">Al Mayor</option>
            </select>
          </div>
          
          <!-- Precio Unitario (Selector) -->
          <div class="col-md-2">
            <label class="form-label">Precio</label>
            <select class="form-select" id="precio-selector" required disabled>
              <option value="">Seleccione precio</option>
            </select>
          </div>
          
          <!-- Unidad -->
          <div class="col-md-2">
            <label class="form-label">Unidad</label>
            <input type="text" class="form-control" id="unidad" readonly placeholder="Seleccione precio">
          </div>
          
          <!-- Cantidad -->
          <div class="col-md-2">
            <label class="form-label">Cantidad</label>
            <input type="number" min="1" value="1" class="form-control" id="cantidad" required disabled>
          </div>
        </div>
        
        <!-- InformaciÃ³n adicional para venta al mayor -->
        <div class="row g-2 mt-2" id="info-mayor" style="display: none;">
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> 
              <span id="info-empaque">Cada paca contiene 0 unidades</span>
            </small>
          </div>
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-calculator"></i> 
              <span id="total-unidades">Total: 0 unidades</span>
            </small>
          </div>
          <div class="col-md-4">
            <small class="text-muted">
              <i class="bi bi-currency-dollar"></i> 
              <span id="subtotal-preview">Subtotal: USD 0.00 (BS 0.00)</span>
            </small>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-principal" id="btn-agregar" disabled>
            <i class="bi bi-cart-plus"></i> AGREGAR
          </button>
        </div>
      </form>
    </div>

    <!-- Carrito de compras -->
    <div class="card-container">
      <h3 class="text-center mb-3">CARRITO DE COMPRAS</h3>
      <div class="table-responsive">
        <table class="table table-carrito">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Tipo</th>
              <th>Cantidad</th>
              <th>Unidades</th>
              <th>P. Unit.</th>
              <th>Subtotal</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="carrito-body">
            <tr>
              <td colspan="7" class="text-center text-muted">No hay productos en el carrito</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="total-container">
        <div class="row">
          <div class="col-md-6">
            <h5 class="mb-0">TOTAL A PAGAR:</h5>
          </div>
          <div class="col-md-6 text-end">
            <h4 class="mb-0" id="total-pagar-usd">USD. 0.00</h4>
            <h5 class="mb-0" id="total-pagar">BS. 0.00</h5>
          </div>
        </div>
      </div>
    </div>

    <!-- Datos de la venta -->
    <div class="form-container">
      <h3 class="text-center mb-3">DATOS DE LA VENTA</h3>
      <form id="form-finalizar-venta">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Fecha</label>
            <input type="date" class="form-control" id="fecha" required>
          </div>
          <!-- El campo de tasa de cambio fue movido arriba -->
          <div class="col-md-6" style="display: none;">
            <!-- Este campo se mantiene oculto para no romper la estructura pero ya no se usado -->
            <input type="number" step="0.01" min="1" class="form-control" id="tasa-cambio-old" value="140">
          </div>
        </div>
        
        <!-- MÃ©todos de pago -->
        <div class="mt-4" id="metodos-pago-container">
          <h5 class="mb-3">MÃTODOS DE PAGO</h5>
          <div id="metodos-pago">
            <!-- Los mÃ©todos de pago se agregarÃ¡n aquÃ­ dinÃ¡micamente -->
          </div>
          
          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-outline-primary" id="btn-agregar-metodo">
              <i class="bi bi-plus-circle"></i> Agregar MÃ©todo de Pago
            </button>
            <div>
              <span id="restante-pagar" class="restante-pendiente">Restante por pagar: USD 0.00 (BS 0.00)</span>
            </div>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-principal" id="btn-finalizar" disabled>
            FINALIZAR VENTA
          </button><br>
          <a class="enlace" href="index.html">
            <button type="button" class="btn btn-principal mt-2">
              â Volver al MenÃº
            </button>
          </a>
        </div>
      </form>
    </div>

    <!-- Loading indicator -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
      <div style="text-align: center; color: white;">
        <svg style="animation: spin 1s linear infinite; width: 40px; height: 40px; margin-bottom: 10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>Procesando venta...</p>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
   // ConfiguraciÃ³n de Supabase
    const SUPABASE_URL = 'https://rirfvhvlmytnpqkcpxbx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJpcmZ2aHZsbXl0bnBxa2NweGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODE2NDUsImV4cCI6MjA3MjA1NzY0NX0.5JLGuOIWNvKIESJG26JLOgRVCu0jVoH0ELZjQ63gV48';
    
    // Inicializar Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let todosLosProductos = [];
    let carrito = [];
    let productoSeleccionado = null;
    let precioSeleccionado = null;
    let monedaPrecioSeleccionado = ''; // 'USD' o 'BS'
    let metodosPago = [];

    function formatearFechaLocal(fechaString) {
      const [year, month, day] = fechaString.split('-');
      const fecha = new Date(year, month - 1, day);
      
      return fecha.toLocaleDateString('es-VE', {
        year: 'numeric',
        month: 'numeric',  
        day: 'numeric'
      });
    }

    // Obtener la tasa de cambio actual del input
    function obtenerTasaCambio() {
      const tasaInput = parseFloat($('#tasa-cambio').val());
      return isNaN(tasaInput) || tasaInput <= 0 ? 140 : tasaInput;
    }

    // Convertir precio de BS a USD usando la tasa del input
    function convertirBsAUsd(precioBs) {
      const tasaActual = obtenerTasaCambio();
      return precioBs / tasaActual;
    }

    // Convertir precio de USD a BS usando la tasa del input
    function convertirUsdABs(precioUsd) {
      const tasaActual = obtenerTasaCambio();
      return precioUsd * tasaActual;
    }

    // Cargar productos desde Supabase
    async function cargarProductos() {
      try {
        console.log('Cargando productos desde Supabase...');
        const { data: productos, error } = await supabaseClient
          .from('productos')
          .select('*')
          .gt('cantidad', 0)
          .order('nombre', { ascending: true });

        if (error) {
          console.error('Error de Supabase:', error);
          throw error;
        }
        
        todosLosProductos = productos || [];
        console.log('Productos cargados:', todosLosProductos);
        inicializarSelect2();
        
      } catch (error) {
        console.error('Error al cargar productos:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al cargar productos: ' + error.message
        });
      }
    }

    // Inicializar Select2 con productos de Supabase
    function inicializarSelect2() {
      console.log('Inicializando Select2 con', todosLosProductos.length, 'productos');
      
      // Limpiar opciones existentes
      $('#producto').empty().append('<option value="">Buscar producto...</option>');
      
      // Agregar productos como opciones
      todosLosProductos.forEach(producto => {
        $('#producto').append(new Option(
          `${producto.nombre} - ${producto.marca || 'Sin marca'}`,
          producto.id,
          false,
          false
        ));
      });
      
      // Inicializar Select2
      $('.js-product-search').select2({
        placeholder: "Buscar producto...",
        width: '100%',
        language: "es"
      });
      
      console.log('Select2 inicializado correctamente');
    }

    // Manejar selecciÃ³n de producto
    function manejarSeleccionProducto() {
      $('#producto').on('change', function() {
        const productoId = $(this).val();
        
        console.log('Producto seleccionado ID:', productoId);
        
        if (productoId) {
          // Obtener el producto seleccionado
          productoSeleccionado = todosLosProductos.find(p => p.id === productoId);
          
          if (productoSeleccionado) {
            console.log('Producto encontrado:', productoSeleccionado);
            
            // Habilitar tipo de venta
            $('#tipo-venta').prop('disabled', false);
            
            // Limpiar campos dependientes
            $('#tipo-venta').val('');
            $('#precio-selector').empty().append('<option value="">Seleccione precio</option>').prop('disabled', true);
            $('#unidad').val('');
            $('#cantidad').val('1').prop('disabled', true);
            $('#btn-agregar').prop('disabled', true);
            ocultarInfoMayor();
          } else {
            console.error('Producto no encontrado en la lista');
          }
        } else {
          productoSeleccionado = null;
          precioSeleccionado = null;
          monedaPrecioSeleccionado = '';
          limpiarCamposDependientes();
        }
      });
    }

    // Llenar selector de precios segÃºn el tipo de venta
    function llenarSelectorPrecios(tipoVenta) {
      if (!productoSeleccionado) return;
      
      $('#precio-selector').empty().append('<option value="">Seleccione precio</option>');
      
      const cantidadPorEmpaque = productoSeleccionado.cantidad_por_empaque || 1;
      
      if (tipoVenta === 'detal') {
        // Para venta al detal, todos los precios se dividen entre cantidad_por_empaque
        // Precio 1: USD (precio_venta_1_usd / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_1_usd && productoSeleccionado.precio_venta_1_usd > 0) {
          const precioDetalUSD = productoSeleccionado.precio_venta_1_usd / cantidadPorEmpaque;
          $('#precio-selector').append(new Option(
            `Precio 1: USD ${precioDetalUSD.toFixed(2)}`,
            JSON.stringify({precio: precioDetalUSD, moneda: 'USD'}),
            false,
            false
          ));
        }
        
        // Precio 2: BS (precio_venta_2 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_2 && productoSeleccionado.precio_venta_2 > 0) {
          const precioDetalBS2 = productoSeleccionado.precio_venta_2 / cantidadPorEmpaque;
          $('#precio-selector').append(new Option(
            `Precio 2: BS ${precioDetalBS2.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS2, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 3: BS (precio_venta_3 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_3 && productoSeleccionado.precio_venta_3 > 0) {
          const precioDetalBS3 = productoSeleccionado.precio_venta_3 / cantidadPorEmpaque;
          $('#precio-selector').append(new Option(
            `Precio 3: BS ${precioDetalBS3.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS3, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 4: BS (precio_venta_4 / cantidad_por_empaque)
        if (productoSeleccionado.precio_venta_4 && productoSeleccionado.precio_venta_4 > 0) {
          const precioDetalBS4 = productoSeleccionado.precio_venta_4 / cantidadPorEmpaque;
          $('#precio-selector').append(new Option(
            `Precio 4: BS ${precioDetalBS4.toFixed(2)}`,
            JSON.stringify({precio: precioDetalBS4, moneda: 'BS'}),
            false,
            false
          ));
        }
      } else if (tipoVenta === 'mayor') {
        // Para venta al mayor, se muestran los precios directamente sin dividir
        // Precio 1: USD (precio_venta_1_usd)
        if (productoSeleccionado.precio_venta_1_usd && productoSeleccionado.precio_venta_1_usd > 0) {
          $('#precio-selector').append(new Option(
            `Precio 1: USD ${productoSeleccionado.precio_venta_1_usd.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_1_usd, moneda: 'USD'}),
            false,
            false
          ));
        }
        
        // Precio 2: BS (precio_venta_2)
        if (productoSeleccionado.precio_venta_2 && productoSeleccionado.precio_venta_2 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 2: BS ${productoSeleccionado.precio_venta_2.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_2, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 3: BS (precio_venta_3)
        if (productoSeleccionado.precio_venta_3 && productoSeleccionado.precio_venta_3 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 3: BS ${productoSeleccionado.precio_venta_3.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_3, moneda: 'BS'}),
            false,
            false
          ));
        }
        
        // Precio 4: BS (precio_venta_4)
        if (productoSeleccionado.precio_venta_4 && productoSeleccionado.precio_venta_4 > 0) {
          $('#precio-selector').append(new Option(
            `Precio 4: BS ${productoSeleccionado.precio_venta_4.toFixed(2)}`,
            JSON.stringify({precio: productoSeleccionado.precio_venta_4, moneda: 'BS'}),
            false,
            false
          ));
        }
      }
      
      // Habilitar selector de precios
      $('#precio-selector').prop('disabled', false);
    }

    // Manejar selecciÃ³n de precio
    function manejarSeleccionPrecio() {
      $('#precio-selector').on('change', function() {
        const precioData = $(this).val();
        
        if (precioData) {
          const data = JSON.parse(precioData);
          precioSeleccionado = data.precio;
          monedaPrecioSeleccionado = data.moneda;
          
          // Si ya estÃ¡ seleccionado el tipo de venta, actualizar cÃ¡lculos
          const tipoVenta = $('#tipo-venta').val();
          if (tipoVenta) {
            actualizarCalculosVenta();
            $('#btn-agregar').prop('disabled', false);
          }
        } else {
          precioSeleccionado = null;
          monedaPrecioSeleccionado = '';
          $('#btn-agregar').prop('disabled', true);
        }
      });
    }

    // Manejar selecciÃ³n de tipo de venta
    function manejarTipoVenta() {
      $('#tipo-venta').on('change', function() {
        const tipoVenta = $(this).val();
        
        if (tipoVenta && productoSeleccionado) {
          // Llenar selector de precios segÃºn el tipo de venta
          llenarSelectorPrecios(tipoVenta);
          
          // Habilitar cantidad inmediatamente al seleccionar tipo de venta
          $('#cantidad').prop('disabled', false);
          
          // Establecer la unidad segÃºn el tipo de venta
          if (tipoVenta === 'detal') {
            $('#unidad').val('Unidad');
            ocultarInfoMayor();
          } else if (tipoVenta === 'mayor') {
            // Verificar que el producto tenga empaque mayor configurado
            if (productoSeleccionado.empaque_mayor && productoSeleccionado.cantidad_por_empaque > 0) {
              $('#unidad').val(productoSeleccionado.empaque_mayor);
              mostrarInfoMayor();
            } else {
              Swal.fire({
                icon: 'warning',
                title: 'Producto sin empaque mayor',
                text: 'Este producto no tiene configurado empaque para venta al mayor'
              });
              $(this).val('');
              $('#unidad').val('');
              $('#cantidad').prop('disabled', true);
              $('#btn-agregar').prop('disabled', true);
              return;
            }
          }
          
          // Si ya hay precio seleccionado, habilitar botÃ³n de agregar
          if (precioSeleccionado) {
            $('#btn-agregar').prop('disabled', false);
            actualizarCalculosVenta();
          }
        } else {
          $('#unidad').val('');
          $('#cantidad').prop('disabled', true);
          $('#btn-agregar').prop('disabled', true);
          ocultarInfoMayor();
        }
      });
    }

    // Mostrar informaciÃ³n para venta al mayor
    function mostrarInfoMayor() {
      const infoMayor = document.getElementById('info-mayor');
      const infoEmpaque = document.getElementById('info-empaque');
      
      infoMayor.style.display = 'block';
      infoEmpaque.textContent = `Cada ${productoSeleccionado.empaque_mayor.toLowerCase()} contiene ${productoSeleccionado.cantidad_por_empaque} unidades`;
    }

    // Ocultar informaciÃ³n para venta al mayor
    function ocultarInfoMayor() {
      document.getElementById('info-mayor').style.display = 'none';
    }

    // Actualizar cÃ¡lculos para la venta
    function actualizarCalculosVenta() {
      const cantidad = parseInt($('#cantidad').val()) || 0;
      const tipoVenta = $('#tipo-venta').val();
      
      if (productoSeleccionado && precioSeleccionado && cantidad > 0) {
        let totalUnidades = cantidad;
        let subtotalUSD = 0;
        let subtotalBs = 0;
        
        if (tipoVenta === 'mayor') {
          totalUnidades = cantidad * productoSeleccionado.cantidad_por_empaque;
        }
        
        // Calcular subtotal segÃºn la moneda del precio seleccionado
        if (monedaPrecioSeleccionado === 'USD') {
          subtotalUSD = cantidad * precioSeleccionado;
          subtotalBs = convertirUsdABs(subtotalUSD);
        } else {
          subtotalBs = cantidad * precioSeleccionado;
          subtotalUSD = convertirBsAUsd(subtotalBs);
        }
        
        $('#total-unidades').text(`Total: ${totalUnidades} unidades`);
        $('#subtotal-preview').text(`Subtotal: USD ${subtotalUSD.toFixed(2)} (BS ${subtotalBs.toFixed(2)})`);
      } else {
        $('#total-unidades').text('Total: 0 unidades');
        $('#subtotal-preview').text('Subtotal: USD 0.00 (BS 0.00)');
      }
    }

    // Manejar cambio de cantidad
    function manejarCambioCantidad() {
      $('#cantidad').on('input', function() {
        actualizarCalculosVenta();
      });
    }

    // Limpiar campos dependientes
    function limpiarCamposDependientes() {
      $('#tipo-venta').val('').prop('disabled', true);
      $('#precio-selector').val('').prop('disabled', true);
      $('#unidad').val('');
      $('#cantidad').val('1').prop('disabled', true);
      $('#btn-agregar').prop('disabled', true);
      ocultarInfoMayor();
    }

    // Verificar stock disponible
    function verificarStock(productoId, cantidadSolicitada, tipoVenta) {
      const producto = todosLosProductos.find(p => p.id === productoId);
      if (!producto) return false;
      
      // Calcular unidades reales segÃºn tipo de venta
      const unidadesReales = tipoVenta === 'mayor' 
        ? cantidadSolicitada * producto.cantidad_por_empaque 
        : cantidadSolicitada;
      
      // Calcular cantidad ya en el carrito
      const itemEnCarrito = carrito.find(item => item.productoId === productoId && item.tipoVenta === tipoVenta);
      const unidadesEnCarrito = itemEnCarrito ? itemEnCarrito.unidades : 0;
      
      return (unidadesEnCarrito + unidadesReales) <= producto.cantidad;
    }

    // Agregar producto al carrito
    function agregarAlCarrito(event) {
      event.preventDefault();
      
      if (!productoSeleccionado) {
        Swal.fire({
          icon: 'warning',
          title: 'Seleccione un producto',
          text: 'Debe seleccionar un producto primero'
        });
        return;
      }
      
      if (!precioSeleccionado) {
        Swal.fire({
          icon: 'warning',
          title: 'Seleccione un precio',
          text: 'Debe seleccionar un precio para el producto'
        });
        return;
      }
      
      const tipoVenta = $('#tipo-venta').val();
      const cantidad = parseInt($('#cantidad').val());
      
      if (!tipoVenta) {
        Swal.fire({
          icon: 'warning',
          title: 'Seleccione tipo de venta',
          text: 'Debe seleccionar el tipo de venta'
        });
        return;
      }
      
      if (!cantidad || cantidad < 1) {
        Swal.fire({
          icon: 'warning',
          title: 'Cantidad invÃ¡lida',
          text: 'Ingrese una cantidad vÃ¡lida'
        });
        return;
      }
      
      // Verificar stock disponible
      if (!verificarStock(productoSeleccionado.id, cantidad, tipoVenta)) {
        Swal.fire({
          icon: 'error',
          title: 'Stock insuficiente',
          text: `No hay suficiente stock disponible para este producto`
        });
        return;
      }
      
      let itemCarrito;
      let unidades = cantidad;
      let precioUnitarioUSD, precioUnitarioBs, subtotalUSD, subtotalBs;
      
      if (tipoVenta === 'mayor') {
        unidades = cantidad * productoSeleccionado.cantidad_por_empaque;
      }
      
      // Calcular precios segÃºn la moneda seleccionada
      if (monedaPrecioSeleccionado === 'USD') {
        precioUnitarioUSD = precioSeleccionado;
        precioUnitarioBs = convertirUsdABs(precioSeleccionado);
        subtotalUSD = cantidad * precioSeleccionado;
        subtotalBs = convertirUsdABs(subtotalUSD);
      } else {
        precioUnitarioBs = precioSeleccionado;
        precioUnitarioUSD = convertirBsAUsd(precioSeleccionado);
        subtotalBs = cantidad * precioSeleccionado;
        subtotalUSD = convertirBsAUsd(subtotalBs);
      }
      
      if (tipoVenta === 'detal') {
        itemCarrito = {
          id: Date.now(),
          productoId: productoSeleccionado.id,
          nombre: productoSeleccionado.nombre,
          marca: productoSeleccionado.marca || '',
          tipoVenta: tipoVenta,
          tipo: 'Al Detal',
          cantidad: cantidad,
          unidades: unidades,
          precioUnitarioUSD: precioUnitarioUSD,
          precioUnitarioBs: precioUnitarioBs,
          subtotalUSD: subtotalUSD,
          subtotalBs: subtotalBs,
          empaqueMayor: null,
          unidadesPorEmpaque: 1,
          monedaPrecio: monedaPrecioSeleccionado
        };
      } else {
        itemCarrito = {
          id: Date.now(),
          productoId: productoSeleccionado.id,
          nombre: productoSeleccionado.nombre,
          marca: productoSeleccionado.marca || '',
          tipoVenta: tipoVenta,
          tipo: `Al Mayor (${productoSeleccionado.empaque_mayor})`,
          cantidad: cantidad, // Cantidad de paquetes
          unidades: unidades, // Total de unidades
          precioUnitarioUSD: precioUnitarioUSD,
          precioUnitarioBs: precioUnitarioBs,
          subtotalUSD: subtotalUSD,
          subtotalBs: subtotalBs,
          empaqueMayor: productoSeleccionado.empaque_mayor,
          unidadesPorEmpaque: productoSeleccionado.cantidad_por_empaque,
          monedaPrecio: monedaPrecioSeleccionado
        };
      }
      
      carrito.push(itemCarrito);
      actualizarVistaCarrito();
      limpiarFormulario();
    }

    // Actualizar vista del carrito
    function actualizarVistaCarrito() {
      const carritoBody = document.getElementById('carrito-body');
      carritoBody.innerHTML = '';
      
      let totalUSD = 0;
      let totalBs = 0;
      
      if (carrito.length === 0) {
        carritoBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay productos en el carrito</td></tr>';
        $('#btn-finalizar').prop('disabled', true);
      } else {
        $('#btn-finalizar').prop('disabled', false);
        
        carrito.forEach((item, index) => {
          const row = document.createElement('tr');
          
          let detalleUnidades = '';
          if (item.tipoVenta === 'mayor') {
            detalleUnidades = `<span class="detalle-unidades">${item.cantidad} ${item.empaqueMayor} Ã ${item.unidadesPorEmpaque} unidades = ${item.unidades} unidades</span>`;
          }
          
          row.innerHTML = `
            <td>${item.nombre}<br><small class="text-muted">${item.marca}</small>${detalleUnidades}</td>
            <td>${item.tipo}</td>
            <td>${item.cantidad}</td>
            <td>${item.unidades}</td>
            <td>USD ${item.precioUnitarioUSD.toFixed(2)}<br><small class="text-muted">BS ${item.precioUnitarioBs.toFixed(2)}</small></td>
            <td>USD ${item.subtotalUSD.toFixed(2)}<br><small class="text-muted">BS ${item.subtotalBs.toFixed(2)}</small></td>
            <td>
              <button type="button" class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${index})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          carritoBody.appendChild(row);
          totalUSD += item.subtotalUSD;
          totalBs += item.subtotalBs;
        });
      }
      
      // Actualizar total en dÃ³lares y bolÃ­vares (USD primero)
      $('#total-pagar-usd').text(`USD ${totalUSD.toFixed(2)}`);
      $('#total-pagar').text(`BS ${totalBs.toFixed(2)}`);
      
      // Actualizar mÃ©todos de pago
      actualizarMetodosPago();
    }

    // Eliminar item del carrito
    function eliminarDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarVistaCarrito();
    }

    // Limpiar formulario
    function limpiarFormulario() {
      $('#producto').val(null).trigger('change');
      productoSeleccionado = null;
      precioSeleccionado = null;
      monedaPrecioSeleccionado = '';
      limpiarCamposDependientes();
    }

    // Calcular el total de la venta en USD
    function calcularTotalVentaUSD() {
      return carrito.reduce((sum, item) => sum + item.subtotalUSD, 0);
    }

    // Calcular el total de la venta en BS
    function calcularTotalVentaBs() {
      return carrito.reduce((sum, item) => sum + item.subtotalBs, 0);
    }

    // Calcular el total pagado en BS
    function calcularTotalPagadoBs() {
      return metodosPago.reduce((sum, metodo) => sum + metodo.montoBs, 0);
    }

    // Calcular el restante por pagar en BS
    function calcularRestantePorPagar() {
      const total = calcularTotalVentaBs();
      const pagado = calcularTotalPagadoBs();
      return total - pagado;
    }

    // Actualizar mÃ©todos de pago
    function actualizarMetodosPago() {
      const totalVentaUSD = calcularTotalVentaUSD();
      const totalVentaBs = calcularTotalVentaBs();
      const totalPagadoBs = calcularTotalPagadoBs();
      const restanteBs = calcularRestantePorPagar();
      const restanteUSD = convertirBsAUsd(restanteBs);
      
      // Actualizar el texto del restante por pagar (primero USD, luego BS)
      const restanteElement = document.getElementById('restante-pagar');
      restanteElement.textContent = `Restante por pagar: USD ${restanteUSD.toFixed(2)} (BS ${restanteBs.toFixed(2)})`;
      
      // Usar un umbral de tolerancia para evitar problemas de redondeo
      if (Math.abs(restanteBs) <= 0.01 && carrito.length > 0) {
        restanteElement.className = 'pago-completado';
        $('#btn-finalizar').prop('disabled', false);
      } else {
        restanteElement.className = 'restante-pendiente';
        $('#btn-finalizar').prop('disabled', true);
      }
      
      // Renderizar mÃ©todos de pago
      const metodosPagoContainer = document.getElementById('metodos-pago');
      metodosPagoContainer.innerHTML = '';
      
      if (metodosPago.length === 0) {
        metodosPagoContainer.innerHTML = '<p class="text-center from-label">No se han agregado mÃ©todos de pago</p>';
        return;
      }
      
      metodosPago.forEach((metodo, index) => {
        const metodoElement = document.createElement('div');
        metodoElement.className = 'metodo-pago';
        metodoElement.innerHTML = `
          <div class="metodo-pago-header">
            <div>
              <strong>${metodo.tipo}</strong>
            </div>
            <div class="total-pago">
              USD ${convertirBsAUsd(metodo.montoBs).toFixed(2)}<br>
              <small>BS ${metodo.montoBs.toFixed(2)}</small>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarMetodoPago(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
        metodosPagoContainer.appendChild(metodoElement);
      });
    }

    // Agregar mÃ©todo de pago - VERSIÃN MODIFICADA
    function agregarMetodoPago() {
      const restanteBs = calcularRestantePorPagar();
      const restanteUSD = convertirBsAUsd(restanteBs);
      
      if (restanteBs <= 0) {
        Swal.fire({
          icon: 'info',
          title: 'Pago completo',
          text: 'Ya se ha cubierto el total de la venta'
        });
        return;
      }
      
      // Crear el HTML del modal segÃºn el tipo de pago
      let modalHTML = `
        <div class="mb-3">
          <label class="form-label">Tipo de Pago</label>
          <select id="swal-tipo-pago" class="form-select">
            <option value="Efectivo">Efectivo</option>
            <option value="DÃ³lares">DÃ³lares</option>
            <option value="Punto de venta">Punto de venta</option>
            <option value="Pago mÃ³vil">Pago mÃ³vil</option>
            <option value="Transferencia">Transferencia</option>
          </select>
        </div>
      `;
      
      // FunciÃ³n para actualizar la interfaz segÃºn el tipo de pago seleccionado
      const actualizarInterfazPago = (tipoPago) => {
        const montoBsElement = document.getElementById('swal-monto-bs');
        const montoUsdElement = document.getElementById('swal-monto-usd');
        const montoLabel = document.getElementById('swal-monto-label');
        const montoConversion = document.getElementById('swal-monto-conversion');
        
        if (tipoPago === 'DÃ³lares') {
          // Para pago en dÃ³lares: mostrar campo USD y conversiÃ³n a BS
          montoLabel.textContent = 'Monto (USD)';
          montoUsdElement.max = restanteUSD;
          montoUsdElement.value = restanteUSD.toFixed(2);
          
          const montoBs = convertirUsdABs(parseFloat(montoUsdElement.value) || 0);
          montoConversion.innerHTML = `Monto en BS: <span id="swal-monto-bs">BS ${montoBs.toFixed(2)}</span>`;
        } else {
          // Para otros mÃ©todos: mostrar campo BS y conversiÃ³n a USD
          montoLabel.textContent = 'Monto (BS)';
          montoUsdElement.max = restanteBs;
          montoUsdElement.value = restanteBs.toFixed(2);
          
          const montoUSD = convertirBsAUsd(parseFloat(montoUsdElement.value) || 0);
          montoConversion.innerHTML = `Monto en USD: <span id="swal-monto-bs">USD ${montoUSD.toFixed(2)}</span>`;
        }
      };
      
      // Agregar campos de monto segÃºn el tipo de pago
      modalHTML += `
        <div class="mb-3">
          <label class="form-label" id="swal-monto-label">Monto (BS)</label>
          <input type="number" step="0.01" min="0.01" max="${restanteBs}" value="${restanteBs.toFixed(2)}" id="swal-monto-usd" class="form-control" style="width: 100%; font-size: 16px; padding: 12px;" required>
        </div>
        <div class="mb-3" id="swal-monto-conversion">
          Monto en USD: <span id="swal-monto-bs">${restanteUSD.toFixed(2)}</span>
        </div>
      `;
      
      Swal.fire({
        title: 'Agregar MÃ©todo de Pago',
        html: modalHTML,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Agregar',
        cancelButtonText: 'Cancelar',
        didOpen: () => {
          // Configurar evento para cambiar entre USD y BS segÃºn el tipo de pago
          const tipoPagoSelect = document.getElementById('swal-tipo-pago');
          const montoInput = document.getElementById('swal-monto-usd');
          
          // Inicializar la interfaz
          actualizarInterfazPago(tipoPagoSelect.value);
          
          // Evento cuando cambia el tipo de pago
          tipoPagoSelect.addEventListener('change', function() {
            actualizarInterfazPago(this.value);
          });
          
          // Evento cuando cambia el monto
          montoInput.addEventListener('input', function() {
            const tipoPago = document.getElementById('swal-tipo-pago').value;
            const monto = parseFloat(this.value) || 0;
            
            if (tipoPago === 'DÃ³lares') {
              // Si es pago en dÃ³lares, calcular BS
              const montoBs = convertirUsdABs(monto);
              document.getElementById('swal-monto-bs').textContent = `BS ${montoBs.toFixed(2)}`;
            } else {
              // Para otros mÃ©todos, calcular USD
              const montoUSD = convertirBsAUsd(monto);
              document.getElementById('swal-monto-bs').textContent = `USD ${montoUSD.toFixed(2)}`;
            }
          });
        },
        preConfirm: () => {
          const tipo = document.getElementById('swal-tipo-pago').value;
          const monto = parseFloat(document.getElementById('swal-monto-usd').value);
          
          if (!monto || monto <= 0) {
            Swal.showValidationMessage('Ingrese un monto vÃ¡lido');
            return false;
          }
          
          let montoBs, montoUSD;
          
          if (tipo === 'DÃ³lares') {
            // Para pago en dÃ³lares: el monto ingresado es en USD
            montoUSD = monto;
            montoBs = convertirUsdABs(monto);
          } else {
            // Para otros mÃ©todos: el monto ingresado es en BS
            montoBs = monto;
            montoUSD = convertirBsAUsd(monto);
          }
          
          // Validar que no exceda el restante por pagar
          if (tipo === 'DÃ³lares' && montoUSD > restanteUSD + 0.01) {
            Swal.showValidationMessage(`El monto no puede ser mayor al restante (USD ${restanteUSD.toFixed(2)})`);
            return false;
          } else if (tipo !== 'DÃ³lares' && montoBs > restanteBs + 0.01) {
            Swal.showValidationMessage(`El monto no puede ser mayor al restante (BS ${restanteBs.toFixed(2)})`);
            return false;
          }
          
          return { tipo, montoBs, montoUSD };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const { tipo, montoBs } = result.value;
          
          // Agregar el mÃ©todo de pago
          metodosPago.push({
            tipo: tipo,
            montoBs: montoBs
          });
          
          actualizarMetodosPago();
        }
      });
    }

    // Eliminar mÃ©todo de pago
    function eliminarMetodoPago(index) {
      metodosPago.splice(index, 1);
      actualizarMetodosPago();
    }
    
    // Finalizar venta en Supabase
    async function finalizarVentaEnSupabase(datosVenta) {
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      try {
        loadingOverlay.style.display = 'flex';
        
        // Obtener la tasa de cambio actual
        const tasaCambio = obtenerTasaCambio();
        
        // Crear string con mÃ©todos de pago para el campo tipo_pago
        const tiposPagoArray = metodosPago.map(pago => pago.tipo);
        const tipoPagoString = tiposPagoArray.join(', ');
        
        // Preparar datos para la tabla ventas
        const ventaParaInsertar = {
          fecha: datosVenta.fecha,
          tipo_pago: tipoPagoString,
          total: parseFloat(datosVenta.totalBs.toFixed(2)),
          tasa_cambio: parseFloat(tasaCambio),
          total_usd: parseFloat(datosVenta.totalUSD.toFixed(2)),
          created_at: new Date().toISOString()
        };
        
        console.log('Datos de venta a insertar:', ventaParaInsertar);
        
        // 1. Crear la venta principal
        const { data: venta, error: errorVenta } = await supabaseClient
          .from('ventas')
          .insert([ventaParaInsertar])
          .select()
          .single();

        if (errorVenta) {
          console.error('Error al insertar venta:', errorVenta);
          throw new Error(`Error al crear venta: ${errorVenta.message}`);
        }

        console.log('Venta creada exitosamente:', venta);

        // 2. Crear los detalles de la venta
        const detallesVenta = datosVenta.productos.map(producto => {
          return {
            venta_id: venta.id,
            producto_id: producto.productoId,
            cantidad: parseInt(producto.unidades),
            tipo_venta: producto.tipoVenta,
            precio_unitario: parseFloat(producto.precioUnitarioBs.toFixed(2)),
            created_at: new Date().toISOString()
          };
        });

        console.log('Detalles de venta a insertar:', detallesVenta);

        const { error: errorDetalles } = await supabaseClient
          .from('detalles_venta')
          .insert(detallesVenta);

        if (errorDetalles) {
          console.error('Error al insertar detalles:', errorDetalles);
          throw new Error(`Error al crear detalles: ${errorDetalles.message}`);
        }

        // 3. Actualizar stock de productos
        for (const producto of datosVenta.productos) {
          const productoActual = todosLosProductos.find(p => p.id === producto.productoId);
          if (!productoActual) {
            throw new Error(`Producto con ID ${producto.productoId} no encontrado`);
          }
          
          const nuevoStock = Math.max(0, productoActual.cantidad - producto.unidades);
          
          console.log(`Actualizando stock del producto ${producto.productoId}: ${productoActual.cantidad} -> ${nuevoStock}`);
          
          const { error: errorStock } = await supabaseClient
            .from('productos')
            .update({ cantidad: nuevoStock })
            .eq('id', producto.productoId);

          if (errorStock) {
            console.error('Error al actualizar stock:', errorStock);
            throw new Error(`Error al actualizar stock: ${errorStock.message}`);
          }
        }

        // 4. Registrar mÃ©todos de pago
        if (metodosPago.length > 0) {
          const pagosVenta = metodosPago.map(metodo => ({
            venta_id: venta.id,
            metodo: metodo.tipo,
            monto_bs: parseFloat(metodo.montoBs.toFixed(2)),
            monto_usd: parseFloat(convertirBsAUsd(metodo.montoBs).toFixed(2)),
            created_at: new Date().toISOString()
          }));

          console.log('Pagos a insertar:', pagosVenta);

          const { error: errorPagos } = await supabaseClient
            .from('pagos_venta')
            .insert(pagosVenta);

          if (errorPagos) {
            console.error('Error al insertar pagos:', errorPagos);
            throw new Error(`Error al registrar pagos: ${errorPagos.message}`);
          }
        }

        loadingOverlay.style.display = 'none';
        
        // Mostrar alerta de Ã©xito
        await Swal.fire({
          icon: 'success',
          title: 'Â¡Venta registrada exitosamente!',
          html: `
            <div style="text-align: left;">
              <p><strong>Fecha:</strong> ${formatearFechaLocal(datosVenta.fecha)}</p>
              <p><strong>Productos vendidos:</strong></p>
              <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                ${datosVenta.productos.map(producto => `
                  <div style="border-bottom: 1px solid #eee; padding: 5px 0;">
                    <strong>${producto.nombre}${producto.marca ? ' - ' + producto.marca : ''}</strong><br>
                    <span style="font-size: 0.9em;">
                      ${producto.tipoVenta === 'mayor' 
                        ? `${producto.cantidad} ${producto.empaqueMayor} Ã ${producto.unidadesPorEmpaque} und = ${producto.unidades} unidades` 
                        : `${producto.cantidad} unidades`
                      }<br>
                      Precio: BS ${producto.precioUnitarioBs.toFixed(2)} c/u<br>
                      Subtotal: BS ${producto.subtotalBs.toFixed(2)}
                    </span>
                  </div>
                `).join('')}
              </div>
              <div style="background-color: #e8f5e8; padding: 10px; border-radius: 5px; border: 1px solid #c3e6c3;">
                <p><strong>Total:</strong> USD ${datosVenta.totalUSD.toFixed(2)} (BS ${datosVenta.totalBs.toFixed(2)})</p>
              </div>
            </div>
          `,
          confirmButtonText: 'Aceptar'
        });
        
        // Limpiar carrito y formulario
        carrito = [];
        metodosPago = [];
        actualizarVistaCarrito();
        actualizarMetodosPago();
        $('#form-finalizar-venta')[0].reset();
        $('#fecha').val(new Date().toISOString().split('T')[0]);
        
        // Recargar productos para actualizar stock
        await cargarProductos();

      } catch (error) {
        loadingOverlay.style.display = 'none';
        console.error('Error al finalizar venta:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al registrar la venta',
          text: error.message || 'OcurriÃ³ un error desconocido',
          footer: 'Por favor, verifique los datos e intente nuevamente'
        });
      }
    }

    // Inicializar cuando se carga el DOM
    $(document).ready(function() {
      // Configurar fecha actual
      $('#fecha').val(new Date().toISOString().split('T')[0]);
      
      // Inicializar funciones
      cargarProductos();
      manejarSeleccionProducto();
      manejarSeleccionPrecio();
      manejarTipoVenta();
      manejarCambioCantidad();
      
      // Event listener para el formulario
      $('#form-agregar-producto').on('submit', agregarAlCarrito);
      
      // Event listener para agregar mÃ©todo de pago
      $('#btn-agregar-metodo').on('click', agregarMetodoPago);
      
      // Event listener para cambio de tasa - ACTUALIZAR EN TIEMPO REAL
      $('#tasa-cambio').on('input', function() {
        const nuevaTasa = parseFloat($(this).val());
        if (nuevaTasa && nuevaTasa > 0) {
          // Actualizar todo en tiempo real
          actualizarVistaCarrito();
          actualizarMetodosPago();
        }
      });
      
      // Event listener para finalizar venta
      $('#form-finalizar-venta').on('submit', async function(e) {
        e.preventDefault();
        
        const fecha = $('#fecha').val();
        const totalUSD = calcularTotalVentaUSD();
        const totalBs = calcularTotalVentaBs();
        
        if (!fecha) {
          Swal.fire({
            icon: 'warning',
            title: 'Fecha requerida',
            text: 'Por favor seleccione una fecha para la venta'
          });
          return;
        }
        
        if (carrito.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Carrito vacÃ­o',
            text: 'No hay productos en el carrito'
          });
          return;
        }
        
        if (metodosPago.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Sin mÃ©todo de pago',
            text: 'Debe agregar al menos un mÃ©todo de pago'
          });
          return;
        }
        
        const restante = calcularRestantePorPagar();
        // Usar un umbral de tolerancia para evitar problemas de redondeo
        if (restante > 0.01) {
          Swal.fire({
            icon: 'warning',
            title: 'Pago incompleto',
            text: `Falta por pagar: BS ${restante.toFixed(2)}`
          });
          return;
        }
        
        // Generar lista detallada de productos para la confirmaciÃ³n
        const productosTexto = carrito.map(item => {
          const marca = item.marca ? ` (${item.marca})` : '';
          let detalle = `â¢ ${item.nombre}${marca}<br>&nbsp;&nbsp;${item.tipo} - ${item.cantidad}`;
          
          if (item.tipoVenta === 'mayor') {
            detalle += ` Ã ${item.unidadesPorEmpaque} unidades = ${item.unidades} unidades`;
          }
          
          detalle += ` Ã BS ${item.precioUnitarioBs.toFixed(2)} = BS ${item.subtotalBs.toFixed(2)}`;
          
          return detalle;
        }).join('<br>');
        
        // Obtener mÃ©todos de pago como texto para mostrar
        const metodosPagoTexto = metodosPago.map(pago => 
          `â¢ ${pago.tipo}: BS ${pago.montoBs.toFixed(2)}`
        ).join('<br>');
        
        // Confirmar venta con informaciÃ³n detallada
        const confirmResult = await Swal.fire({
          title: 'Â¿Confirmar venta?',
          html: `
            <div style="text-align: left; font-size: 0.95em;">
              <p><strong>ð Fecha:</strong> ${formatearFechaLocal(fecha)}</p>
              <p><strong>ð Productos (${carrito.length} items):</strong></p>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #f8f9fa;">
                ${productosTexto}
              </div>
              <p style="margin-top: 15px;"><strong>ð³ MÃ©todos de pago:</strong></p>
              <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background-color: #f8f9fa;">
                ${metodosPagoTexto}
              </div>
              <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; border: 1px solid #c3e6c3;">
                <strong>ð° Total a pagar:</strong><br>
                USD ${totalUSD.toFixed(2)} (BS ${totalBs.toFixed(2)})
              </div>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'SÃ­, confirmar venta',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          width: '600px'
        });
        
        if (confirmResult.isConfirmed) {
          await finalizarVentaEnSupabase({
            fecha,
            productos: carrito,
            totalUSD: totalUSD,
            totalBs: totalBs
          });
        }
      });
      
      // Inicializar vista del carrito
      actualizarVistaCarrito();
      
      console.log('Sistema de ventas inicializado correctamente');
    });

    // Hacer funciones globales para que estÃ©n disponibles en los eventos onclick
    window.eliminarDelCarrito = eliminarDelCarrito;
    window.eliminarMetodoPago = eliminarMetodoPago;
  </script>
</body>
</html>